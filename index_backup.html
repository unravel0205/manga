<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¼«ç”»ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .tooltip { visibility: hidden; opacity: 0; transition: opacity 0.2s; }
    .tooltip-trigger:hover .tooltip { visibility: visible; opacity: 1; }
    .scrollbar-thin::-webkit-scrollbar { height: 6px; width: 6px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
    .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
    .accordion-content.open { max-height: 2000px; }
    @media (max-width: 768px) {
      .sidebar { position: fixed; left: -100%; top: 0; height: 100vh; z-index: 50; transition: left 0.3s ease; width: 85%; max-width: 360px; }
      .sidebar.open { left: 0; }
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div id="app"></div>

  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/htm@3/dist/htm.umd.js"></script>
  
  <script>
    var html = htm.bind(React.createElement);
    var useState = React.useState;
    var useEffect = React.useEffect;
    var useRef = React.useRef;

    // å®šæ•°
    var STYLES = [
      { id: 1, name: 'ãƒ“ã‚¸ãƒã‚¹èª¬æ˜ãƒãƒ³ã‚¬é¢¨', desc: 'ä¼æ¥­å‘ã‘ãƒ“ã‚¸ãƒã‚¹æ›¸ãƒ»ã¾ã‚“ãŒã§ã‚ã‹ã‚‹â—‹â—‹ã‚·ãƒªãƒ¼ã‚ºã®å„ªã—ã„ã‚¿ãƒƒãƒ', prompt: 'Japanese josei manga illustration style for business books. Soft natural color palette with warm beige skin tones and natural brown hair. Delicate thin linework with subtle line weight variation. Soft gradient shading, not cel-shaded. Realistic proportions with slightly large but natural-looking eyes. Clean, professional, and approachable atmosphere. Detailed hair strands with natural flow. Gentle highlights and minimal shadows. Style similar to "manga de wakaru" business book illustrations.' },
      { id: 2, name: 'å°‘å¹´æ¼«ç”»é¢¨', desc: 'é€±åˆŠå°‘å¹´ã‚¸ãƒ£ãƒ³ãƒ—é¢¨ãƒ»ãƒ¯ãƒ³ãƒ”ãƒ¼ã‚¹/ãƒ‰ãƒ©ã‚´ãƒ³ãƒœãƒ¼ãƒ«ã®ã‚ˆã†ãªè¿«åŠ›ãƒãƒˆãƒ«', prompt: 'Japanese Weekly Shonen Jump manga illustration style, full color spread page quality. Extremely bold heavy ink linework with exaggerated line weight variation, extra thick black outlines on characters that pop off the page. Hyper-detailed background art with dramatic forced perspective and foreshortening. Intensely vivid oversaturated colors with hard cel-shading and deep black shadows. Extreme high contrast lighting with powerful directional light source, strong rim lighting, and glowing color bleeds. Screentone texture overlay for authentic print feeling. Over-the-top dynamic composition breaking panel boundaries. Extreme camera angles - ultra low angle looking up, severe dutch angle, exaggerated fish-eye distortion. Characters bursting out of frame toward viewer. Explosive speed lines filling entire background, dense impact lines radiating from action points, heavy motion blur streaks. Flying debris, shattering rocks, dust clouds, sparks, and energy particles everywhere. Shockwave ripples and impact craters. Exaggerated anatomy with dynamic impossible poses, muscles tensed at peak action, clothing and hair blown by intense force. Screaming expressions with wide eyes and intense emotion visible. Battle aura effects, glowing energy emanating from characters, light beam attacks, flame or lightning effects. Onomatopoeia sound effect aesthetics integrated into composition. Color palette with extreme complementary contrasts - hot orange against cool blue, vivid red against deep green. Background practically vibrating with energy. Character colors cranked to maximum saturation against darker dramatic backgrounds. Raw hand-drawn ink texture with visible brush strokes, confident and aggressive linework. Peak Weekly Shonen Jump double-page spread impact and intensity.' },
      { id: 3, name: 'å°‘å¥³æ¼«ç”»é¢¨', desc: 'ã‚Šã¼ã‚“ãƒ»ãªã‹ã‚ˆã—é¢¨ãƒ»ã‚»ãƒ¼ãƒ©ãƒ¼ãƒ ãƒ¼ãƒ³/ã‚«ãƒ¼ãƒ‰ã‚­ãƒ£ãƒ—ã‚¿ãƒ¼ã•ãã‚‰ã®ã‚­ãƒ©ã‚­ãƒ©ä¸–ç•Œ', prompt: 'Japanese classic shoujo manga illustration style, full color magazine cover quality. Extremely delicate graceful linework with elegant flowing strokes, impossibly fine detailed lines for each individual hair strand flowing like silk in the wind. Overwhelmingly large sparkling eyes taking up half the face, filled with multiple layered star-shaped highlights, galaxy-like gradient irises with jewel-like depth, impossibly long dramatic eyelashes with individual strands visible. Eyes reflecting entire universes of emotion and light. Explosively dreamy backgrounds completely filled with floating roses, cherry blossoms, lilies cascading everywhere. Thousands of sparkles, glitter particles, and diamond dust filling every empty space. Soap bubbles with rainbow reflections, soft feathers floating, ribbons swirling through the air. Ultra soft ethereal pastel color palette - delicate pink, dreamy lavender, heavenly baby blue, pearl white with iridescent shimmer. Colors so soft they seem to glow from within. Extreme airbrush-style gradients melting seamlessly into each other. Overwhelming light effects - lens flares bursting like stars, soft focus bokeh everywhere, holy light rays streaming down, rainbow prism effects, glowing halos around characters. Everything bathed in magical golden hour lighting. Hair flowing in impossible dramatic waves defying gravity, each strand catching light individually, hair so detailed it looks like liquid silk or spun gold. Clothing billowing ethereally as if underwater or in zero gravity. Intensely emotional expressions - huge glistening tears like crystal jewels catching light, deep blushes spreading across cheeks with soft gradient, lips with glass-like shine and perfect highlights. Decorative elements overflowing - intricate lace patterns, satin ribbons, pearl accessories, crystal jewelry catching prismatic light. Ornate floral borders framing the scene. Screen tone texture with delicate flower patterns, soft dot gradients creating dreamy atmosphere. Peak Ribon or Nakayoshi magazine cover impact - overwhelmingly beautiful and romantic aesthetic that takes breath away.' },
      { id: 4, name: 'ã‚·ãƒ³ãƒ—ãƒ«ç·šç”»é¢¨', desc: 'åŒ—æ¬§ãƒŸãƒ‹ãƒãƒ«ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ»ç„¡å°è‰¯å“/Apple UIã®ã‚ˆã†ãªæ¥µé™ã‚·ãƒ³ãƒ—ãƒ«', prompt: 'Ultra minimalist vector line art illustration style, extreme geometric simplification. Perfectly uniform clean black outlines with mathematically precise thickness, no variation or hand-drawn imperfection whatsoever. Radically simplified shapes - circles, rectangles, triangles only. Human figures reduced to essential geometric forms, faces with dot eyes and single line expressions or no facial features at all. Objects stripped down to absolute iconic silhouettes instantly recognizable with minimum detail. Completely flat solid colors with absolutely zero gradients, zero shadows, zero highlights, zero texture. Pure unmodulated color fills like digital paint bucket tool. Limited color palette - maximum 3-4 colors plus black and white. Extreme negative space utilization - bold empty areas as important as filled areas. Perfectly balanced asymmetrical composition. Every element placed with mathematical precision and intentional breathing room. Razor sharp vector edges, infinitely scalable appearance. Colors either bold primary palette or sophisticated muted Scandinavian tones - dusty pink, sage green, warm gray, mustard yellow. No decorative elements whatsoever - no patterns, no textures, no ornaments. If it can be removed without losing meaning, it is removed. Absolute economy of visual information. Clean modern tech company aesthetic meets Scandinavian design philosophy. Swiss graphic design precision. Museum of Modern Art poster quality minimalism.' },
      { id: 5, name: 'ã‚¢ãƒ¡ã‚³ãƒŸé¢¨', desc: 'ãƒãƒ¼ãƒ™ãƒ«/DCã‚³ãƒŸãƒƒã‚¯ã‚¹ãƒ»ã‚¹ãƒ‘ã‚¤ãƒ€ãƒ¼ãƒãƒ³/ãƒãƒƒãƒˆãƒãƒ³é¢¨ã®ãƒãƒƒãƒ—ãªã‚¢ãƒ¡ãƒªã‚«ãƒ³', prompt: 'Classic American superhero comic book illustration style, full color splash page quality. Extremely bold heavy black ink outlines with aggressive confident brushwork, thick to thin line variation showing hand-inked craftsmanship. Cross-hatching and feathering techniques for dramatic shadow rendering. Hyper-muscular heroic anatomy with exaggerated proportions - massive shoulders, impossibly broad chests, chiseled jawlines, dynamic impossible poses showing extreme foreshortening. Capes and costumes billowing dramatically with every fold and wrinkle rendered. Veins visible on tensed muscles. Intensely vibrant saturated colors - primary red, blue, yellow popping off the page. Bold complementary color clashes creating visual impact. Colors so vivid they practically glow. Heavy halftone Ben-Day dot patterns visible throughout - dots on skin tones, dots in shadows, dots creating gradients and atmospheric effects. Authentic vintage newsprint comic aesthetic with CMYK color separation feeling. Extreme dramatic lighting with stark noir-influenced shadows. Pure black shadow areas with sharp cutoffs, intense rim lighting outlining figures against dark backgrounds. Multiple dramatic light sources creating complex shadow interplay. Kirby Krackle cosmic energy effects - black dot clusters representing cosmic power and explosions. Energy beams, lightning bolts, power auras crackling around characters. Explosive impact bursts and starburst effects. Hyper-detailed urban destruction backgrounds - crumbling skyscrapers, shattered concrete, flying debris, billowing smoke clouds, cracked asphalt, bent steel girders. Epic sense of scale with tiny figures against massive destruction. Over-the-top action composition bursting beyond panel borders. Extreme camera angles - severe worm\'s eye view looking up at towering heroes, dramatic bird\'s eye capturing citywide chaos. Fists and feet punching directly toward viewer breaking the fourth wall. Sound effect aesthetic integrated - impact feels like visible POW, WHAM, KRACKOOM even without text. Visual noise and energy radiating from every action. Classic Marvel and DC bronze age aesthetic meets modern Image Comics intensity. Jack Kirby cosmic grandeur combined with Jim Lee hyper-detailed rendering. Print-ready newsstand comic book cover impact.' },
      { id: 6, name: 'æ°´å½©ã‚¤ãƒ©ã‚¹ãƒˆé¢¨', desc: 'çµµæœ¬ãƒ»æ°´å½©ç”»é¢¨ãƒ»ã‚¸ãƒ–ãƒªèƒŒæ™¯ç¾è¡“ã®ã‚ˆã†ãªæŸ”ã‚‰ã‹ãæ¸©ã‹ã„æ°´å½©ã‚¿ãƒƒãƒ', prompt: 'Traditional watercolor painting illustration style, fine art gallery exhibition quality. Extremely loose expressive brushwork with visible confident brush strokes dancing across the surface. Wet-on-wet technique creating magical unpredictable color blooms and bleeds spreading organically. Heavily visible cold-pressed watercolor paper texture - rough tooth surface catching pigment in valleys, creating beautiful granulation effects. Paper grain showing through transparent washes. Pure white of paper glowing through as brightest highlights, never covered with white paint. Dreamy soft edges melting into each other where colors meet, bleeding and feathering beautifully. Occasional crisp hard edges for contrast where wet meets dry. Cauliflower blooms and backruns embraced as happy accidents adding organic authenticity. Luminous transparent color layers built up through multiple glazing washes - colors glowing from within as light passes through pigment to paper and reflects back. Visible layering where previous washes peek through subsequent layers creating color depth impossible in opaque media. Pigment granulation and separation visible - heavier pigments settling into paper texture creating speckled effects. Sedimentary pigments like ultramarine and burnt sienna showing natural granular texture. Color separating into component pigments in wet washes. Water marks and tide lines where puddles dried, salt texture effects creating snowflake patterns, deliberate splatter and spray adding energy and movement. Drips running down occasionally left as artistic elements. Color palette either soft ethereal pastels with diluted washes or rich vibrant concentrated pigments pooling in shadows. Atmospheric perspective through increasingly diluted cooler washes for distant elements. Warm concentrated colors for foreground, pale cool hints for background. Loose gestural quality - suggesting rather than defining, leaving areas unfinished and breathing. Strategic unpainted white spaces as important design elements. Edges lost and found throughout composition guiding the eye. Authentic traditional watercolor aesthetic - handmade imperfection, organic unpredictability, luminosity only achievable through transparent water media. Fine art watercolor society exhibition quality, museum-worthy traditional painting appearance.' },
      { id: 7, name: 'ãƒ¬ãƒˆãƒ­æ¼«ç”»é¢¨', desc: 'æ˜­å’Œãƒ¬ãƒˆãƒ­æ¼«ç”»ãƒ»ãƒ™ãƒ«ã‚µã‚¤ãƒ¦ã®ã°ã‚‰/ã‚­ãƒ£ãƒ³ãƒ‡ã‚£ã‚­ãƒ£ãƒ³ãƒ‡ã‚£ã®æ‡ã‹ã—ã„é›°å›²æ°—', prompt: 'Authentic vintage Japanese manga illustration style from 1970s-1980s golden age era, full color magazine illustration quality. Classic hand-drawn ink linework with visible pen nib texture - G-pen bold strokes for outlines, Maru-pen delicate lines for details, Kabura-pen for hair strands. Iconic retro character design - large sparkling eyes with dramatic star-shaped highlights and heavy black areas, distinctively thick eyebrows, pointed chins, impossibly long legs with exaggerated height proportions. Feathered hair with dramatic volume and wings, era-specific hairstyles reflecting 70s-80s fashion. Heavy authentic screen tone usage throughout - IC Screen and Letraset tone patterns visible. Mechanical dot tones for shading, gradient tones for atmospheric effects, decorative pattern tones for clothing and backgrounds. Sand tones, cross-hatch tones, sparkle effect tones layered for depth. Nostalgic vintage color palette limited by period printing technology - slightly misaligned CMYK registration creating subtle color bleeds. Warm yellowed paper undertone as if aged newsprint. Saturated but slightly muted colors - distinctive orange-reds, turquoise blues, mustard yellows, dusty pinks specific to era printing. Dramatic speed lines and effect lines hand-drawn with ruler precision. Beta-flash technique with white radiating from black. Emotion symbols - sweat drops, anger veins, sparkle backgrounds, flower frames for beautiful moments. Detailed realistic backgrounds contrasting with stylized characters - urban Japanese cityscapes, detailed interior rooms with period-accurate furniture and technology, school buildings, trains. Visible analog production artifacts - white-out correction marks, slight ink bleeding at line intersections, paste-up edges where tones were cut and applied by hand. Authentic pre-digital manga craftsmanship visible throughout. Emotional dramatic atmosphere with characteristic manga storytelling visual language. Style reminiscent of Shonen Sunday, Margaret, or Ribon magazine illustrations from the era. Museum of manga history exhibition quality, preserving authentic golden age aesthetic.' },
      { id: 8, name: 'Webtooné¢¨', desc: 'éŸ“å›½ã‚¦ã‚§ãƒ–ãƒˆã‚¥ãƒ¼ãƒ³ãƒ»ä¿ºã ã‘ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—/ç¥ä¹‹å¡”ã®ç¾ä»£çš„ãƒ‡ã‚¸ã‚¿ãƒ«è¡¨ç¾', prompt: 'Modern Korean webtoon illustration style, premium platform featured series quality. Immaculately clean digital linework with perfect smooth curves, crisp confident outlines with subtle thickness variation. Ultra-polished professional digital art finish with no visible brush texture. Stunning modern character designs reflecting Korean beauty standards - small perfectly proportioned faces, flawless porcelain skin with luminous glow, high nose bridges, delicate lips with glass-like shine, perfectly groomed eyebrows. Large expressive eyes but more realistic than Japanese manga - detailed iris patterns with multiple light reflections, natural double eyelids, subtle eye makeup visible. Impossibly beautiful hair rendered strand by strand with silky smooth highlights, perfectly styled K-drama worthy hairstyles catching light beautifully. Hair color ranging from natural blacks and browns to trendy Korean hair colors - ash gray, burgundy, honey brown with subtle highlights. Ultra-soft airbrushed shading with seamless gradient transitions, no hard cel-shading edges. Delicate blushing on cheeks, nose tips, and ears with soft pink diffusion. Subsurface scattering effect on skin creating lifelike translucency, especially on ears and fingertips catching backlight. Fashion-forward contemporary clothing with meticulous fabric rendering - designer brands, trendy Korean street fashion, perfectly fitted suits, flowing dresses with realistic fabric physics. Detailed accessories - luxury watches, earrings, necklaces, designer bags all rendered with care. Cinematic atmospheric backgrounds with intentional depth of field blur - sharp focused characters against dreamy bokeh backgrounds. Modern Korean urban settings - stylish cafes, luxury apartments, Seoul cityscape, university campuses, corporate offices all rendered with architectural accuracy. Sophisticated color palette with harmonious color theory - soft pastels for romance genres, moody desaturated tones for thriller/drama, vibrant saturated colors for fantasy. Characteristic soft purple, pink, and blue atmospheric color grading throughout. Dramatic cinematic lighting with multiple soft light sources - warm golden hour glow, cool blue moonlight, neon city reflections, soft window light. Rim lighting separating characters from backgrounds, lens flares and light leaks adding filmic quality. Vertical scroll composition optimized with dramatic reveals and pacing. Strategic use of extreme close-ups on emotional eyes and faces. Dynamic camera angles creating webtoon-specific visual storytelling impact. Peak Naver Webtoon or Kakao Page premium series quality. Production value rivaling top-tier series like "True Beauty", "Lore Olympus", or "Solo Leveling". Professional Korean digital illustration studio quality throughout.' },
      { id: 9, name: 'çµµæœ¬ã‚¤ãƒ©ã‚¹ãƒˆé¢¨', desc: 'ãƒ”ãƒ¼ã‚¿ãƒ¼ãƒ©ãƒ“ãƒƒãƒˆ/ã“ãã¾ã¡ã‚ƒã‚“/ã¯ã‚‰ãºã“ã‚ãŠã‚€ã—ã®æ¸©ã‹ã„çµµæœ¬ä¸–ç•Œ', prompt: 'Heartwarming children\'s picture book illustration style, award-winning Caldecott Medal quality. Impossibly soft rounded shapes with no sharp edges anywhere - every corner curved, every form pillowy and huggable. Characters designed to be maximally endearing and lovable. Extremely warm inviting color palette radiating comfort - soft buttercream yellows, cozy terracotta oranges, gentle sage greens, warm rosy pinks, comforting sky blues. Colors feel like a warm blanket, a cup of cocoa, a gentle hug from grandmother. Visible handcrafted traditional media texture throughout - soft colored pencil strokes with waxy buildup, gentle watercolor washes bleeding softly at edges, gouache opacity with subtle brushwork visible, crayon texture with paper grain showing through. Mixed media layering creating rich tactile depth. Adorable character designs with exaggerated cute proportions - oversized round heads on small bodies, huge sparkling innocent eyes full of wonder, tiny button noses, rosy chubby cheeks that beg to be pinched. Simplified rounded hands like mittens, stubby little legs. Expressions radiating pure joy, curiosity, and warmth. Whimsical fantastical backgrounds bursting with cozy details - tiny mushroom houses with smoking chimneys, rolling gentle hills like soft pillows, friendly trees with faces, winding paths inviting exploration. Every element anthropomorphized and friendly - smiling suns, sleepy moons, cheerful flowers waving hello. Rich storytelling details rewarding close inspection - tiny creatures hiding in corners, secret doorways, miniature scenes within scenes. Visual narrative depth encouraging repeated viewing and discovery. Magical golden hour lighting bathing everything in warmth - soft diffused light with no harsh shadows, gentle glowing highlights, everything lit as if by candlelight or sunset. Light itself feels cozy and safe. Nostalgic timeless quality evoking beloved childhood memories - style reminiscent of classic Beatrix Potter, Eric Carle tactile quality, Oliver Jeffers whimsy, Jon Klassen subtle humor. Museum of children\'s literature exhibition quality, destined to become treasured bedtime reading for generations.' },
      { id: 10, name: 'ã‚¯ãƒ¼ãƒ«ãƒ»ã‚¹ã‚¿ã‚¤ãƒªãƒƒã‚·ãƒ¥é¢¨', desc: 'ãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³èªŒé¢¨ãƒ»NANA/Paradise Kissã®ãƒ¢ãƒãƒˆãƒ¼ãƒ³ã§ãŠã—ã‚ƒã‚Œãªè¡¨ç¾', prompt: 'Ultra-cool sophisticated Japanese manga illustration style, high-end fashion magazine editorial quality. Razor-sharp confident ink linework with extreme precision, bold black strokes with dramatic thick-to-thin variation. Heavy use of pure blacks creating striking silhouettes and noir-like contrast. Predominantly monochromatic palette - deep rich blacks, pure bright whites, and full spectrum of sophisticated grays. Strategic limited accent colors used sparingly for maximum visual impact - single striking red on lips or blood, electric blue on eyes or neon signs, vibrant orange on cigarette ember or sunset. Color so selective it becomes symbolic and meaningful. Impossibly stylish character designs with model-like proportions - tall lean figures, sharp angular facial features, high cheekbones, narrow intense eyes with piercing gaze. Cool detached expressions radiating effortless confidence and mysterious allure. Characters look like they belong on fashion runways or in indie film posters. Hyper-detailed contemporary fashion rendered with obsessive precision - designer leather jackets with every zipper and stitch visible, perfectly tailored black suits, flowing oversized coats, avant-garde streetwear. Fabric textures meticulously rendered - leather shine, denim weave, silk drape, knit patterns. Accessories as character statements - designer sunglasses, silver jewelry, expensive watches, statement earrings. Cinematic urban nightscape backgrounds dripping with atmosphere - rain-slicked Tokyo streets reflecting neon, towering skyscrapers disappearing into fog, underground club interiors with dramatic lighting, empty late-night train platforms, rooftop silhouettes against city lights. Architecture rendered with precise perspective and urban grit. Dramatic noir-influenced lighting creating extreme contrast - harsh single light sources casting deep black shadows, rim lighting outlining figures against darkness, neon glow painting colored light on faces, cigarette smoke catching beams of light. Shadows as important as lit areas. Heavy screen tone usage for sophisticated gray gradations - mechanical dot patterns creating smooth transitions, gradient tones for atmospheric depth, cross-hatch tones for textured shadows. Analog manga craftsmanship with modern aesthetic sensibility. Edgy artistic composition with unconventional framing - extreme close-ups on eyes and lips, figures cropped dramatically at frame edges, negative space used boldly, dutch angles creating tension and unease. Visual rhythm between dense detailed areas and stark empty spaces. Cool detached atmosphere with underlying emotional intensity - style reminiscent of "Nana", "Paradise Kiss", "Gangsta", "Tokyo Ghoul" aesthetic sophistication. Fashion editorial meets underground manga culture. Gallery exhibition quality art book appearance.' },
      { id: 99, name: 'ç”»åƒã‹ã‚‰å‚ç…§', desc: 'æ·»ä»˜ç”»åƒã®é›°å›²æ°—ã«åˆã‚ã›ã¾ã™', prompt: '' }
    ];

    var MODELS = [
      { id: '4k', name: 'é«˜å“è³ª 4Kï¼ˆæœ‰æ–™ï¼‰', model: 'gemini-3-pro-image-preview', price: 0.24, jpy: 36 },
      { id: '2k', name: 'é«˜å“è³ª 2Kï¼ˆæœ‰æ–™ï¼‰', model: 'gemini-3-pro-image-preview', price: 0.134, jpy: 20 },
      { id: 'free', name: 'æ¨™æº–ï¼ˆç„¡æ–™ï¼‰', model: 'gemini-2.5-flash-image', price: 0, jpy: 0 }
    ];

    var SAMPLES = [
      { id: 1, cat: 'ãƒ“ã‚¸ãƒã‚¹', title: 'ãƒ“ã‚¸ãƒã‚¹èª¬æ˜ãƒãƒ³ã‚¬', style: 1 },
      { id: 2, cat: 'æ•™è‚²', title: 'æ•™è‚²ç³»è§£èª¬ãƒãƒ³ã‚¬', style: 1 },
      { id: 3, cat: 'å•†å“ç´¹ä»‹', title: 'å•†å“ç´¹ä»‹ãƒãƒ³ã‚¬', style: 8 },
      { id: 4, cat: 'ãƒ“ã‚¸ãƒã‚¹', title: 'æ¡ç”¨åºƒå ±ãƒãƒ³ã‚¬', style: 2 },
      { id: 5, cat: 'æ•™è‚²', title: 'æ­´å²è§£èª¬ãƒãƒ³ã‚¬', style: 7 },
      { id: 6, cat: 'å•†å“ç´¹ä»‹', title: 'ã‚µãƒ¼ãƒ“ã‚¹ç´¹ä»‹', style: 3 }
    ];

    var HELP = {
      api: 'ã€APIã‚­ãƒ¼å–å¾—æ‰‹é †ã€‘\n\n1. https://aistudio.google.com/ ã«ã‚¢ã‚¯ã‚»ã‚¹\n2. Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³\n3. å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€ŒGet API Keyã€ã‚’ã‚¯ãƒªãƒƒã‚¯\n4. ã€ŒCreate API Keyã€ã‚’ã‚¯ãƒªãƒƒã‚¯\n5. è¡¨ç¤ºã•ã‚ŒãŸã‚­ãƒ¼ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆAIza...ã§å§‹ã¾ã‚‹ï¼‰\n6. ã“ã®ã‚¢ãƒ—ãƒªã«è²¼ã‚Šä»˜ã‘ã¦ã€Œä¿å­˜ã€\n\nâ€»ã‚­ãƒ¼ã¯ä»–äººã«å…±æœ‰ã—ãªã„ã§ãã ã•ã„',
      model: 'ã€ãƒ¢ãƒ‡ãƒ«é¸æŠã€‘\n\nâ–  é«˜å“è³ª 4Kï¼ˆæœ‰æ–™ï¼‰\n$0.24/æšï¼ˆç´„36å††ï¼‰æœ€é«˜å“è³ª\n\nâ–  é«˜å“è³ª 2Kï¼ˆæœ‰æ–™ï¼‰\n$0.134/æšï¼ˆç´„20å††ï¼‰é«˜å“è³ª\n\nâ–  æ¨™æº–ï¼ˆç„¡æ–™ï¼‰\n1æ—¥500æšã¾ã§ç„¡æ–™',
      character: 'ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šã€‘\n\nâ–  èª¬æ˜è€…ï¼ˆå¿…é ˆï¼‰\nãƒ¡ã‚¤ãƒ³ã§è©±ã‚’é€²ã‚ã‚‹ã‚­ãƒ£ãƒ©\n\nâ–  ç›¸è«‡è€…ï¼ˆä»»æ„ï¼‰\nè³ªå•å½¹ã€‚è¨­å®šã™ã‚‹ã¨ä¼šè©±å½¢å¼ã«\n\nâ–  å‚è€ƒ3ãƒ»4ï¼ˆä»»æ„ï¼‰\næ¼«ç”»ã«ç™»å ´ã•ã›ãŸã„å†™çœŸãªã©',
      style: 'ã€çµµã®ãƒ†ã‚¤ã‚¹ãƒˆã€‘\nçµµæŸ„ã‚’é¸æŠã§ãã¾ã™ã€‚\nâ˜…ã§ãŠæ°—ã«å…¥ã‚Šç™»éŒ²ã™ã‚‹ã¨ä¸Šã«è¡¨ç¤ºã€‚\nã€Œç”»åƒã‹ã‚‰å‚ç…§ã€ã§æ·»ä»˜ç”»åƒã«åˆã‚ã›ã¾ã™ã€‚',
      story: 'ã€å…¥åŠ›ã®ã‚³ãƒ„ã€‘\nãƒ»100ã€œ500æ–‡å­—ç¨‹åº¦ãŒç›®å®‰\nãƒ»ç®‡æ¡æ›¸ãã§ã‚‚OK\nãƒ»æ„Ÿæƒ…ã‚’å…¥ã‚Œã‚‹ã¨è¡¨ç¾è±Šã‹ã«'
    };

    var TUTORIAL = [
      { title: 'ã‚ˆã†ã“ãï¼', content: 'ã“ã®ãƒ„ãƒ¼ãƒ«ã§ã¯ã€ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’å…¥åŠ›ã™ã‚‹ã ã‘ã§\n4ã‚³ãƒæ¼«ç”»ãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™ã€‚\n\nã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚„çµµã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’\nè‡ªç”±ã«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã§ãã¾ã™ã€‚' },
      { title: 'STEP 1: APIã‚­ãƒ¼è¨­å®š', content: 'Google AI Studioã§APIã‚­ãƒ¼ã‚’å–å¾—ã—ã€\nè¨­å®šã—ã¦ãã ã•ã„ã€‚\n\nç„¡æ–™ã§å–å¾—ã§ãã¾ã™ã€‚\nè©³ã—ãã¯ã€Œ?ã€ãƒãƒ¼ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼' },
      { title: 'STEP 2: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼', content: 'èª¬æ˜è€…ï¼ˆå¿…é ˆï¼‰ã¨ç›¸è«‡è€…ï¼ˆä»»æ„ï¼‰ã®\nç”»åƒã‚’è¨­å®šã—ã¾ã™ã€‚\n\nãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ä¿å­˜ã™ã‚‹ã¨\næ¬¡å›ã‹ã‚‰ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ä½¿ãˆã¾ã™ã€‚' },
      { title: 'STEP 3: ã‚¹ã‚¿ã‚¤ãƒ«', content: 'çµµã®ãƒ†ã‚¤ã‚¹ãƒˆã‚’10ç¨®é¡ä»¥ä¸Šã‹ã‚‰é¸æŠã€‚\n\nã‚»ãƒªãƒ•ã®è©±ã—æ–¹ï¼ˆæ•¬èª/ã‚¿ãƒ¡å£ï¼‰ã‚‚\né¸ã¹ã¾ã™ã€‚' },
      { title: 'STEP 4: ç”Ÿæˆï¼', content: 'ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’å…¥åŠ›ã—ã¦\nã€Œæ¼«ç”»ã‚’ç”Ÿæˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼\n\nè¤‡æ•°æšã®åŒæ™‚ç”Ÿæˆã‚‚ã§ãã¾ã™ã€‚\nã•ã‚ã€å§‹ã‚ã¾ã—ã‚‡ã†ï¼' }
    ];

    // ãƒ˜ãƒ«ãƒ—ã‚¢ã‚¤ã‚³ãƒ³
    function HelpIcon(props) {
      return html`
        <div class="tooltip-trigger relative inline-block ml-2">
          <div class="w-5 h-5 bg-gray-200 rounded-full flex items-center justify-center cursor-help text-xs text-gray-600 font-bold hover:bg-gray-300">?</div>
          <div class="tooltip absolute z-50 w-72 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-lg left-7 top-0 whitespace-pre-wrap">${props.text}</div>
        </div>
      `;
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«
    function Modal(props) {
      if (!props.isOpen) return null;
      var sizes = { sm: 'max-w-md', md: 'max-w-2xl', lg: 'max-w-4xl', full: 'max-w-[95vw]' };
      return html`
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick=${props.onClose}>
          <div class="bg-white rounded-xl w-full ${sizes[props.size] || sizes.md} max-h-[90vh] overflow-hidden flex flex-col" onClick=${function(e) { e.stopPropagation(); }}>
            <div class="flex justify-between items-center p-4 border-b">
              <h3 class="text-lg font-bold">${props.title}</h3>
              <button onClick=${props.onClose} class="text-gray-500 hover:text-gray-700 text-2xl leading-none">Ã—</button>
            </div>
            <div class="overflow-y-auto flex-1 p-4">${props.children}</div>
          </div>
        </div>
      `;
    }

    // ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª
    function App() {
      var s1 = useState(''); var apiKey = s1[0], setApiKey = s1[1];
      var s2 = useState(false); var apiSaved = s2[0], setApiSaved = s2[1];
      var s3 = useState(false); var showApi = s3[0], setShowApi = s3[1];
      var s4 = useState([]); var chars = s4[0], setChars = s4[1];
      var s5 = useState([null, null, null, null]); var selChars = s5[0], setSelChars = s5[1];
      var s6 = useState(1); var style = s6[0], setStyle = s6[1];
      var s7 = useState(null); var styleRef = s7[0], setStyleRef = s7[1];
      var s8 = useState([]); var favStyles = s8[0], setFavStyles = s8[1];
      var s9 = useState('formal'); var speech = s9[0], setSpeech = s9[1];
      var s10 = useState('4k'); var model = s10[0], setModel = s10[1];
      var s11 = useState(''); var story = s11[0], setStory = s11[1];
      var s12 = useState(1); var genCount = s12[0], setGenCount = s12[1];
      var s13 = useState([]); var genImages = s13[0], setGenImages = s13[1];
      var s14 = useState(0); var curImg = s14[0], setCurImg = s14[1];
      var s15 = useState(false); var isGen = s15[0], setIsGen = s15[1];
      var s16 = useState(0); var genIdx = s16[0], setGenIdx = s16[1];
      var s17 = useState(''); var error = s17[0], setError = s17[1];
      var s18 = useState([]); var history = s18[0], setHistory = s18[1];
      var s19 = useState([]); var favHist = s19[0], setFavHist = s19[1];
      var s20 = useState([]); var projects = s20[0], setProjects = s20[1];
      var s21 = useState(null); var curProj = s21[0], setCurProj = s21[1];
      var s22 = useState({ monthly: [], total: { count: 0, cost: 0 } }); var usage = s22[0], setUsage = s22[1];
      var s23 = useState(false); var sidebar = s23[0], setSidebar = s23[1];
      var s24 = useState(['char', 'style']); var accord = s24[0], setAccord = s24[1];
      var s25 = useState(null); var lastSave = s25[0], setLastSave = s25[1];
      var s26 = useState(false); var showTut = s26[0], setShowTut = s26[1];
      var s27 = useState(0); var tutStep = s27[0], setTutStep = s27[1];
      var s28 = useState(false); var showSamp = s28[0], setShowSamp = s28[1];
      var s29 = useState(false); var showHist = s29[0], setShowHist = s29[1];
      var s30 = useState(false); var showUsage = s30[0], setShowUsage = s30[1];
      var s31 = useState(false); var showAddChar = s31[0], setShowAddChar = s31[1];
      var s32 = useState(false); var showAddProj = s32[0], setShowAddProj = s32[1];
      var s33 = useState(false); var showImg = s33[0], setShowImg = s33[1];
      var s34 = useState(null); var modalImg = s34[0], setModalImg = s34[1];
      var s35 = useState(false); var showHistDet = s35[0], setShowHistDet = s35[1];
      var s36 = useState(null); var histDet = s36[0], setHistDet = s36[1];
      var s37 = useState(false); var showDraft = s37[0], setShowDraft = s37[1];
      var s38 = useState(null); var draft = s38[0], setDraft = s38[1];
      var s39 = useState(''); var newCharName = s39[0], setNewCharName = s39[1];
      var s40 = useState(null); var newCharImg = s40[0], setNewCharImg = s40[1];
      var s41 = useState(''); var newProjName = s41[0], setNewProjName = s41[1];
      var s42 = useState([]); var promptSteps = s42[0], setPromptSteps = s42[1];
      var s43 = useState(0); var currentStep = s43[0], setCurrentStep = s43[1];
      var s44 = useState(0); var totalSteps = s44[0], setTotalSteps = s44[1];
      var s45 = useState('simple'); var genMode = s45[0], setGenMode = s45[1];
      var s46 = useState(0); var modalImgIdx = s46[0], setModalImgIdx = s46[1];
      var s47 = useState(1); var charAbsentCount = s47[0], setCharAbsentCount = s47[1];
      var s48 = useState(false); var enableSubChars = s48[0], setEnableSubChars = s48[1];
      var s49 = useState([{name: '', features: ''}, {name: '', features: ''}, {name: '', features: ''}, {name: '', features: ''}]); var charDetails = s49[0], setCharDetails = s49[1];
      var s50 = useState(false); var showCharDetail = s50[0], setShowCharDetail = s50[1];
      var s51 = useState(0); var charDetailIdx = s51[0], setCharDetailIdx = s51[1];
      var s52 = useState(false); var showPanelHelp = s52[0], setShowPanelHelp = s52[1];
      var s53 = useState(false); var showAdvancedSettings = s53[0], setShowAdvancedSettings = s53[1];

      var fileRef = useRef(null);
      var charRefs = useRef([null, null, null, null]);
      var styleRefInput = useRef(null);
      var cancelRef = useRef(false);

      // åˆæœŸåŒ–
      useEffect(function() {
        try {
          var k = localStorage.getItem('manga_api_key');
          if (k) { setApiKey(k); setApiSaved(true); }
          var c = localStorage.getItem('manga_chars');
          if (c) setChars(JSON.parse(c));
          var f = localStorage.getItem('manga_fav_styles');
          if (f) setFavStyles(JSON.parse(f));
          var h = localStorage.getItem('manga_history');
          if (h) {
            try {
              var histData = JSON.parse(h);
              // å±¥æ­´ãŒ10ä»¶ã‚’è¶…ãˆã¦ã„ã‚‹å ´åˆã¯å‰Šæ¸›
              if (histData.length > 10) {
                histData = histData.slice(0, 10);
                localStorage.setItem('manga_history', JSON.stringify(histData));
                console.log('å±¥æ­´ã‚’10ä»¶ã«å‰Šæ¸›ã—ã¾ã—ãŸ');
              }
              setHistory(histData);
            } catch(e) {
              console.error('å±¥æ­´èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
              // ç ´æã—ã¦ã„ã‚‹å ´åˆã¯ç©ºã«ã™ã‚‹
              localStorage.setItem('manga_history', '[]');
              setHistory([]);
            }
          }
          var fh = localStorage.getItem('manga_fav_hist');
          if (fh) setFavHist(JSON.parse(fh));
          var p = localStorage.getItem('manga_projects');
          if (p) setProjects(JSON.parse(p));
          var u = localStorage.getItem('manga_usage');
          if (u) setUsage(JSON.parse(u));
          var t = localStorage.getItem('manga_tut_seen');
          if (!t) setShowTut(true);
          var d = localStorage.getItem('manga_draft');
          if (d) {
            var dd = JSON.parse(d);
            if (dd.story && dd.story.length > 0) { setDraft(dd); setShowDraft(true); }
          }
          var m = localStorage.getItem('manga_gen_mode');
          if (m) setGenMode(m);
          var ca = localStorage.getItem('manga_char_absent_count');
          if (ca) setCharAbsentCount(parseInt(ca, 10));
          var sc = localStorage.getItem('manga_enable_sub_chars');
          if (sc) setEnableSubChars(sc === 'true');
          var cd = localStorage.getItem('manga_char_details');
          if (cd) setCharDetails(JSON.parse(cd));
        } catch(e) { console.error(e); }
      }, []);

      // ãƒ•ã‚¡ã‚¤ãƒ«åãƒ‘ãƒ¼ã‚¹: "01_åˆ†æ_text.txt" â†’ { order: 1, name: "åˆ†æ", type: "text" }
      function parseFileName(filename) {
        var parts = filename.replace('.txt', '').split('_');
        if (parts.length < 3) return null;
        return {
          order: parseInt(parts[0], 10),
          name: parts.slice(1, -1).join('_'),
          type: parts[parts.length - 1]
        };
      }

      // ã‚°ãƒ­ãƒ–ãƒ‘ã‚¿ãƒ¼ãƒ³ã§è©¦ã™ãƒ•ã‚¡ã‚¤ãƒ«åå€™è£œ
      function generateFilePatterns(num) {
        var numStr = String(num).padStart(2, '0');
        var names = ['åˆ†æ', 'æ§‹æˆ', 'è¨­è¨ˆ', 'è©³ç´°', 'ç”»åƒç”Ÿæˆ', 'analysis', 'structure', 'design', 'detail', 'image', 'generation'];
        var types = ['text', 'image'];
        var patterns = [];

        names.forEach(function(name) {
          types.forEach(function(type) {
            patterns.push(numStr + '_' + name + '_' + type + '.txt');
          });
        });

        return patterns;
      }

      // 1ã¤ã®ç•ªå·ã§æœ€åˆã«è¦‹ã¤ã‹ã£ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
      function tryLoadOneNumber(num) {
        var patterns = generateFilePatterns(num);

        return Promise.race(
          patterns.map(function(filename) {
            return fetch('./prompts/' + filename)
              .then(function(res) {
                if (!res.ok) throw new Error('Not found');
                return res.text().then(function(txt) {
                  var parsed = parseFileName(filename);
                  return {
                    file: filename,
                    name: parsed.name,
                    type: parsed.type,
                    template: txt,
                    order: parsed.order
                  };
                });
              });
          })
        ).catch(function() {
          return null;
        });
      }

      // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ï¼ˆç°¡æ˜“ç‰ˆï¼‰
      useEffect(function() {
        function loadPrompts() {
          // ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
          var mode = localStorage.getItem('manga_gen_mode') || 'simple';
          var knownFiles;

          if (mode === 'simple') {
            knownFiles = [
              { file: '01_ç°¡æ˜“_image.txt', name: 'ç°¡æ˜“', type: 'image', order: 1 }
            ];
          } else {
            knownFiles = [
              { file: '01_åˆ†æ_text.txt', name: 'åˆ†æ', type: 'text', order: 1 },
              { file: '02_ç”»åƒç”Ÿæˆ_image.txt', name: 'ç”»åƒç”Ÿæˆ', type: 'image', order: 2 }
            ];
          }

          var promises = knownFiles.map(function(fileInfo) {
            return fetch('./prompts/' + fileInfo.file)
              .then(function(res) {
                if (!res.ok) throw new Error('Not found');
                return res.text();
              })
              .then(function(template) {
                return {
                  file: fileInfo.file,
                  name: fileInfo.name,
                  type: fileInfo.type,
                  order: fileInfo.order,
                  template: template
                };
              })
              .catch(function(err) {
                console.warn('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å¤±æ•—:', fileInfo.file, err.message);
                return null;
              });
          });

          Promise.all(promises)
            .then(function(results) {
              var foundSteps = results.filter(function(r) { return r !== null; });

              if (foundSteps.length === 0) {
                console.error('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ä½¿ç”¨ã—ã¾ã™ã€‚');
                foundSteps = [
                  { file: '01_åˆ†æ_text.txt', name: 'åˆ†æ', type: 'text', template: getDefaultPromptStep1(), order: 1 },
                  { file: '02_ç”»åƒç”Ÿæˆ_image.txt', name: 'ç”»åƒç”Ÿæˆ', type: 'image', template: getDefaultPromptStep2(), order: 2 }
                ];
              }

              foundSteps.sort(function(a, b) { return a.order - b.order; });
              setPromptSteps(foundSteps);
              setTotalSteps(foundSteps.length);
              console.log('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆèª­ã¿è¾¼ã¿å®Œäº†:', foundSteps.length + 'ã‚¹ãƒ†ãƒƒãƒ—');
              foundSteps.forEach(function(s) {
                console.log('  âœ“ ' + s.file + ' (' + s.name + ', ' + s.type + ')');
              });
            });
        }

        loadPrompts();
      }, [genMode]);

      // ä¸‹æ›¸ãè‡ªå‹•ä¿å­˜
      useEffect(function() {
        var timer = setTimeout(function() {
          try {
            localStorage.setItem('manga_draft', JSON.stringify({ story: story, style: style, speech: speech, model: model, genCount: genCount, ts: new Date().toISOString() }));
            setLastSave(new Date());
          } catch(e) {}
        }, 3000);
        return function() { clearTimeout(timer); };
      }, [story, style, speech, model, genCount]);

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã§ã®ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œ
      useEffect(function() {
        if (!showImg) return;

        function handleKeyDown(e) {
          if (e.key === 'ArrowLeft' && modalImgIdx > 0) {
            setModalImgIdx(modalImgIdx - 1);
          } else if (e.key === 'ArrowRight' && modalImgIdx < genImages.length - 1) {
            setModalImgIdx(modalImgIdx + 1);
          } else if (e.key === 'Escape') {
            setShowImg(false);
          }
        }

        window.addEventListener('keydown', handleKeyDown);
        return function() {
          window.removeEventListener('keydown', handleKeyDown);
        };
      }, [showImg, modalImgIdx, genImages.length]);

      function restoreDraft() {
        if (draft) {
          setStory(draft.story || '');
          setStyle(draft.style || 1);
          setSpeech(draft.speech || 'formal');
          setModel(draft.model || '4k');
          setGenCount(draft.genCount || 1);
        }
        setShowDraft(false);
      }

      function saveApi() {
        localStorage.setItem('manga_api_key', apiKey);
        setApiSaved(true);
      }

      function toggleFavStyle(id) {
        var nf = favStyles.indexOf(id) >= 0 ? favStyles.filter(function(x) { return x !== id; }) : favStyles.concat([id]);
        setFavStyles(nf);
        localStorage.setItem('manga_fav_styles', JSON.stringify(nf));
      }

      // ç”»åƒåœ§ç¸®é–¢æ•°
      function compressImage(dataUrl, maxWidth, quality) {
        return new Promise(function(resolve) {
          var img = new Image();
          img.onload = function() {
            var canvas = document.createElement('canvas');
            var ctx = canvas.getContext('2d');

            // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ä¿æŒã—ã¦ãƒªã‚µã‚¤ã‚º
            var width = img.width;
            var height = img.height;

            if (width > maxWidth) {
              height = Math.round((height * maxWidth) / width);
              width = maxWidth;
            }

            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);

            // åœ§ç¸®ã—ã¦æ–°ã—ã„Data URLã‚’å–å¾—
            var compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
            resolve(compressedDataUrl);
          };
          img.src = dataUrl;
        });
      }

      function addChar() {
        if (!newCharName || !newCharImg) return;
        // ç”»åƒã‚’åœ§ç¸®ã—ã¦ã‹ã‚‰ä¿å­˜ï¼ˆæœ€å¤§å¹…400pxã€å“è³ª0.6ï¼‰
        compressImage(newCharImg, 400, 0.6).then(function(compressedImg) {
          var nc = { id: 'c_' + Date.now(), name: newCharName, img: compressedImg };
          var ncs = chars.concat([nc]);
          setChars(ncs);
          localStorage.setItem('manga_chars', JSON.stringify(ncs));
          setShowAddChar(false);
          setNewCharName('');
          setNewCharImg(null);
        });
      }

      function delChar(id) {
        if (!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
        var ncs = chars.filter(function(c) { return c.id !== id; });
        setChars(ncs);
        localStorage.setItem('manga_chars', JSON.stringify(ncs));
        setSelChars(selChars.map(function(c) { return c && c.id === id ? null : c; }));
      }

      function handleFile(e, idx) {
        var f = e.target.files[0];
        if (!f) return;
        var r = new FileReader();
        r.onload = function(ev) {
          // ä¸€æ™‚ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚‚åœ§ç¸®ã—ã¦ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã‚’å‰Šæ¸›
          compressImage(ev.target.result, 500, 0.7).then(function(compressedImg) {
            var nc = selChars.slice();
            nc[idx] = { id: 't_' + Date.now(), name: f.name, img: compressedImg, temp: true };
            setSelChars(nc);
          });
        };
        r.readAsDataURL(f);
      }

      function openCharDetail(idx) {
        setCharDetailIdx(idx);
        setShowCharDetail(true);
      }

      function updateCharDetail(idx, field, value) {
        var newDetails = charDetails.slice();
        newDetails[idx] = Object.assign({}, newDetails[idx], { [field]: value });
        setCharDetails(newDetails);
        localStorage.setItem('manga_char_details', JSON.stringify(newDetails));
      }

      // ã‚³ãƒæƒ…å ±ã‚’æŠ½å‡º
      function extractPanelInfo(storyText) {
        var panelPattern = /ã€ã‚³ãƒ(\d+)ã€‘([^ã€]*)/g;
        var panels = [];
        var match;

        while ((match = panelPattern.exec(storyText)) !== null) {
          var content = match[2].trim();

          var panel = {
            number: panels.length + 1, // è‡ªå‹•çš„ã«1ã‹ã‚‰æŒ¯ã‚Šç›´ã™
            position: '',
            size: '',
            speech: '',
            background: '',
            character: '',
            expression: '',
            cameraAngle: '',
            cameraDistance: '',
            content: '' // å†…å®¹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ 
          };

          // å„é …ç›®ã‚’æŠ½å‡º
          var posMatch = content.match(/ä½ç½®[ï¼š:]\s*([^\n]+)/);
          if (posMatch) panel.position = posMatch[1].trim();

          var sizeMatch = content.match(/ã‚µã‚¤ã‚º[ï¼š:]\s*([^\n]+)/);
          if (sizeMatch) panel.size = sizeMatch[1].trim();

          var speechMatch = content.match(/ã‚»ãƒªãƒ•[ï¼š:]\s*([^\n]+)/);
          if (speechMatch) panel.speech = speechMatch[1].trim();

          var bgMatch = content.match(/èƒŒæ™¯[ï¼š:]\s*([^\n]+)/);
          if (bgMatch) panel.background = bgMatch[1].trim();

          var charMatch = content.match(/ã‚­ãƒ£ãƒ©[ï¼š:]\s*([^\n]+)/);
          if (charMatch) panel.character = charMatch[1].trim();

          var exprMatch = content.match(/è¡¨æƒ…[ï¼š:]\s*([^\n]+)/);
          if (exprMatch) panel.expression = exprMatch[1].trim();

          var angleMatch = content.match(/ã‚«ãƒ¡ãƒ©ã‚¢ãƒ³ã‚°ãƒ«[ï¼š:]\s*([^\n]+)/);
          if (angleMatch) panel.cameraAngle = angleMatch[1].trim();

          var distMatch = content.match(/ã‚«ãƒ¡ãƒ©è·é›¢[ï¼š:]\s*([^\n]+)/);
          if (distMatch) panel.cameraDistance = distMatch[1].trim();

          var contentMatch = content.match(/å†…å®¹[ï¼š:]\s*([^\n]+)/);
          if (contentMatch) panel.content = contentMatch[1].trim();

          panels.push(panel);
        }

        return panels;
      }

      // ã‚³ãƒæƒ…å ±ã‹ã‚‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæŒ‡ç¤ºã‚’ç”Ÿæˆ
      function generateLayoutInstructions(panels) {
        if (panels.length === 0) return '';

        var instructions = '\n\nğŸš¨ğŸš¨ğŸš¨ CRITICAL OVERRIDE - CUSTOM PANEL LAYOUT ğŸš¨ğŸš¨ğŸš¨\n\n';
        instructions += 'âš ï¸ THIS IS A ' + panels.length + '-PANEL MANGA, NOT A 4-PANEL MANGA âš ï¸\n';
        instructions += 'âš ï¸ REPEAT: ' + panels.length + ' PANELS ONLY. DO NOT CREATE 4 PANELS. âš ï¸\n';
        instructions += 'âš ï¸ IF YOU CREATE ' + (panels.length === 2 ? '3 OR 4' : panels.length === 3 ? '2 OR 4' : '2 OR 3') + ' PANELS, IT IS WRONG. âš ï¸\n\n';

        instructions += 'â–  ABSOLUTE PANEL COUNT: ' + panels.length + ' panels (NO MORE, NO LESS)\n';
        instructions += 'â–  This overrides any default 4-panel instructions elsewhere in the prompt\n';
        instructions += 'â–  Panel count is MANDATORY and NON-NEGOTIABLE\n\n';

        instructions += 'ã€DETAILED PANEL SPECIFICATIONSã€‘\n\n';

        panels.forEach(function(panel) {
          instructions += 'â”â”â” Panel ' + panel.number + ' of ' + panels.length + ' â”â”â”\n';
          if (panel.position) instructions += 'ğŸ“ Position: ' + panel.position + '\n';
          if (panel.size) instructions += 'ğŸ“ Size: ' + panel.size + '\n';
          if (panel.content) instructions += 'ğŸ¬ Content: ' + panel.content + '\n';
          if (panel.speech) instructions += 'ğŸ’¬ Speech: ' + panel.speech + '\n';
          if (panel.background) instructions += 'ğŸ–¼ï¸  Background: ' + panel.background + '\n';
          if (panel.character) instructions += 'ğŸ‘¤ Character: ' + panel.character + '\n';
          if (panel.expression) instructions += 'ğŸ˜Š Expression: ' + panel.expression + '\n';
          if (panel.cameraAngle) instructions += 'ğŸ“· Camera Angle: ' + panel.cameraAngle + '\n';
          if (panel.cameraDistance) instructions += 'ğŸ”­ Camera Distance: ' + panel.cameraDistance + '\n';
          instructions += '\n';
        });

        instructions += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';
        instructions += 'ğŸ”´ CRITICAL REQUIREMENTS:\n';
        instructions += 'âœ“ Create EXACTLY ' + panels.length + ' panels (count them before generating)\n';
        instructions += 'âœ“ Follow the exact positions and sizes specified above\n';
        instructions += 'âœ“ Use the speech bubbles and content specified for each panel\n';
        instructions += 'âœ“ Maintain 2:3 vertical aspect ratio for the entire image\n';
        instructions += 'âœ“ Draw clear panel borders between panels\n';
        instructions += 'âœ“ Ensure all ' + panels.length + ' panels fit within a single vertical image\n\n';

        instructions += 'âŒ DO NOT:\n';
        instructions += 'Ã— Create 4 panels (this is a ' + panels.length + '-panel manga)\n';
        instructions += 'Ã— Add extra panels beyond the ' + panels.length + ' specified\n';
        instructions += 'Ã— Ignore the custom layout instructions\n';
        instructions += 'Ã— Use default 4-panel layout\n\n';

        instructions += 'ğŸš¨ REMINDER: This is a ' + panels.length + '-panel manga. Count: ' + panels.length + '. Not 4. (' + panels.length + ' panels) ğŸš¨\n';

        return instructions;
      }

      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
      function getDefaultPromptStep1() {
        return 'ã‚ãªãŸã¯æ¼«ç”»åˆ¶ä½œã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚\nä»¥ä¸‹ã®ã‚¹ãƒˆãƒ¼ãƒªãƒ¼å†…å®¹ã‚’åˆ†æã—ã€4ã‚³ãƒæ¼«ç”»ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã®è©³ç´°ãªç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚\n\nã€å‡ºåŠ›å½¢å¼ã€‘\nå„ã‚³ãƒã”ã¨ã«è©³ç´°ã‚’æ˜è¨˜ã—ã¦ãã ã•ã„ã€‚\n\n---\nã€ã‚¹ãƒˆãƒ¼ãƒªãƒ¼å†…å®¹ã€‘\n{{STORY}}';
      }

      function getDefaultPromptStep2() {
        return 'ä»¥ä¸‹ã®æŒ‡ç¤ºã«å¾“ã£ã¦4ã‚³ãƒæ¼«ç”»ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚\n\n{{GENERATED_PROMPT}}\n\nã€ç”»åƒå…¨ä½“ã®æ¡ä»¶ã€‘\nãƒ»ç¸¦é•·1æšç”»åƒã€ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯” 2:3\nãƒ»4Ké«˜è§£åƒåº¦ã€ã‚«ãƒ©ãƒ¼æ¼«ç”»';
      }

      // å¤‰æ•°ç½®æ›
      function replaceVars(template, vars) {
        var result = template;
        Object.keys(vars).forEach(function(key) {
          var regex = new RegExp('{{' + key + '}}', 'g');
          result = result.replace(regex, vars[key]);
        });
        return result;
      }

      function genPrompt() {
        var st = STYLES.find(function(s) { return s.id === style; });
        var hasC = selChars[1] !== null;
        var spt = (style === 99 && styleRef) ? 'æ·»ä»˜ã•ã‚ŒãŸå‚ç…§ç”»åƒã®çµµæŸ„ãƒ»è‰²ä½¿ã„ãƒ»é›°å›²æ°—ã«å¿ å®Ÿã«åˆã‚ã›ã¦ãã ã•ã„ã€‚' : st.prompt;
        var spch = speech === 'formal' ? 'æ•¬èªï¼ˆã§ã™ãƒ»ã¾ã™èª¿ï¼‰ã‚’åŸºæœ¬ã¨ã—ã€åŒã˜èªå°¾ãŒé€£ç¶šã—ãªã„ã‚ˆã†3ç¨®é¡ä»¥ä¸Šä½¿ã„åˆ†ã‘ã‚‹' : 'ã‚¿ãƒ¡å£ï¼ˆã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ï¼‰ã‚’åŸºæœ¬ã¨ã—ã€è¦ªã—ã¿ã‚„ã™ãã€èªå°¾ã‚’3ç¨®é¡ä»¥ä¸Šä½¿ã„åˆ†ã‘ã‚‹';
        var charRule = hasC ? 'ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã€‘2äººæ§‹æˆã€‚1æšç›®ã®ç”»åƒãŒèª¬æ˜å½¹ã€2æšç›®ãŒç›¸è«‡å½¹' : 'ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã€‘1äººã§èª­è€…ã«èªã‚Šã‹ã‘ã‚‹å½¢å¼';
        var refTxt = (selChars[2] || selChars[3]) ? 'ã€å‚è€ƒç”»åƒã€‘è¿½åŠ ã®å‚è€ƒç”»åƒã‚’æ¼«ç”»å†…ã§é©åˆ‡ã«ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚' : '';
        return (hasC ? '2äºº' : '1äºº') + 'ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒä¼šè©±å½¢å¼ã§èªã‚‹ãƒãƒ³ã‚¬ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚\n\nã€çµµã®ãƒ†ã‚¤ã‚¹ãƒˆã€‘\n' + spt + '\n\nã€ã‚»ãƒªãƒ•ã‚¹ã‚¿ã‚¤ãƒ«ã€‘\n' + spch + '\n\n' + charRule + '\n\n' + refTxt + '\n\nã€ç”»åƒæ¡ä»¶ã€‘\nãƒ»ç¸¦é•·1æšã€ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯” 2:3\nãƒ»ä¸Šã‹ã‚‰ç¸¦ã«4ã‚³ãƒæ§‹æˆ\nãƒ»æ—¥æœ¬èªã¯ç¸¦æ›¸ãã€å³ã‹ã‚‰å·¦\nãƒ»ã‚«ãƒ©ãƒ¼ã®ã¿\n\n---\nã€è¨˜äº‹å†…å®¹ã€‘\n' + story;
      }

      // å…±é€šå¤‰æ•°ã‚’å–å¾—
      function getCommonVars() {
        var st = STYLES.find(function(s) { return s.id === style; });
        var hasC = selChars[1] !== null;
        var spt = (style === 99 && styleRef) ? 'æ·»ä»˜ã•ã‚ŒãŸå‚ç…§ç”»åƒã®çµµæŸ„ãƒ»è‰²ä½¿ã„ãƒ»é›°å›²æ°—ã«å¿ å®Ÿã«åˆã‚ã›ã¦ãã ã•ã„ã€‚' : st.prompt;

        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç™»å ´ãƒ‘ãƒãƒ«æ•°ã«å¿œã˜ãŸæ–‡å­—æ•°ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³
        var charPresentPanels = 4 - charAbsentCount;
        var charCountGuide = '';
        if (charAbsentCount === 0) {
          charCountGuide = '\n\nã€æ–‡å­—æ•°ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã€‘\nãƒ»ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç™»å ´ãƒ‘ãƒãƒ«ï¼š4ã‚³ãƒå…¨ã¦\nãƒ»ç·ã‚»ãƒªãƒ•æ–‡å­—æ•°ï¼š90-120æ–‡å­—ï¼ˆç†æƒ³ï¼š100-110æ–‡å­—ï¼‰\nãƒ»1ãƒ‘ãƒãƒ«ã‚ãŸã‚Šå¹³å‡ï¼š22-30æ–‡å­—';
        } else if (charAbsentCount === 1) {
          charCountGuide = '\n\nã€æ–‡å­—æ•°ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã€‘\nãƒ»ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç™»å ´ãƒ‘ãƒãƒ«ï¼š3ã‚³ãƒ\nãƒ»ç·ã‚»ãƒªãƒ•æ–‡å­—æ•°ï¼š70-90æ–‡å­—ï¼ˆç†æƒ³ï¼š75-85æ–‡å­—ï¼‰\nãƒ»1ãƒ‘ãƒãƒ«ã‚ãŸã‚Šå¹³å‡ï¼š23-30æ–‡å­—';
        } else if (charAbsentCount === 2) {
          charCountGuide = '\n\nã€æ–‡å­—æ•°ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã€‘\nãƒ»ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç™»å ´ãƒ‘ãƒãƒ«ï¼š2ã‚³ãƒ\nãƒ»ç·ã‚»ãƒªãƒ•æ–‡å­—æ•°ï¼š50-70æ–‡å­—ï¼ˆç†æƒ³ï¼š55-65æ–‡å­—ï¼‰\nãƒ»1ãƒ‘ãƒãƒ«ã‚ãŸã‚Šå¹³å‡ï¼š25-35æ–‡å­—';
        }

        var spch = speech === 'formal'
          ? 'ã€ã‚»ãƒªãƒ•ãƒ»èªå°¾ã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆé‡è¦ï¼‰ã€‘\nãƒ»æ•¬èªï¼ˆã§ã™ãƒ»ã¾ã™èª¿ï¼‰ã‚’åŸºæœ¬ã¨ã™ã‚‹\nãƒ»åŒã˜èªå°¾ãŒé€£ç¶šã—ãªã„ã‚ˆã†ã«ã™ã‚‹\nãƒ»4ã‚³ãƒå†…ã§æœ€ä½3ç¨®é¡ä»¥ä¸Šã®èªå°¾ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½¿ã„åˆ†ã‘ã‚‹\nãƒ»ä»¥ä¸‹ã‹ã‚‰è‡ªç„¶ã«æ··ãœã‚‹ï¼š\nã€€å•ã„ã‹ã‘ç³»ï¼ˆã€œã§ã™ã‹ï¼Ÿï¼ã€œã§ã—ã‚‡ã†ã‹ï¼‰\nã€€èª¬æ˜ç³»ï¼ˆã€œãªã‚“ã§ã™ï¼ã€œã¦ãŠã‚Šã¾ã™ï¼‰\nã€€å±•é–‹ç³»ï¼ˆã€œã§ã™ãŒã€ï¼å®Ÿã¯ã€œï¼ã¤ã¾ã‚Šã€œï¼‰\nã€€å¼·èª¿ç³»ï¼ˆã€œãªã®ã§ã™ï¼ã€œã¨è¨€ãˆã¾ã™ï¼‰\nã€€ç· ã‚ç³»ï¼ˆã€œã—ã¾ã—ã‚‡ã†ï¼ã€œã—ã¦ã¿ã¦ãã ã•ã„ï¼‰' + charCountGuide
          : 'ã€ã‚»ãƒªãƒ•ãƒ»èªå°¾ã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆé‡è¦ï¼‰ã€‘\nãƒ»ã‚¿ãƒ¡å£ï¼ˆã ãƒ»ã§ã‚ã‚‹èª¿ã€ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ï¼‰ã‚’åŸºæœ¬ã¨ã™ã‚‹\nãƒ»åŒã˜èªå°¾ãŒé€£ç¶šã—ãªã„ã‚ˆã†ã«ã™ã‚‹\nãƒ»4ã‚³ãƒå†…ã§æœ€ä½3ç¨®é¡ä»¥ä¸Šã®èªå°¾ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½¿ã„åˆ†ã‘ã‚‹\nãƒ»ä»¥ä¸‹ã‹ã‚‰è‡ªç„¶ã«æ··ãœã‚‹ï¼š\nã€€å•ã„ã‹ã‘ç³»ï¼ˆã€œã ã‚ˆã­ï¼Ÿï¼ã€œã˜ã‚ƒãªã„ï¼Ÿï¼ã€œã‹ãªï¼Ÿï¼‰\nã€€èª¬æ˜ç³»ï¼ˆã€œãªã‚“ã ï¼ã€œã ã‚ˆï¼ã€œã£ã¦ã“ã¨ï¼‰\nã€€å±•é–‹ç³»ï¼ˆã€œã ã‘ã©ã€ï¼å®Ÿã¯ã€œï¼ã¤ã¾ã‚Šã€œï¼‰\nã€€å¼·èª¿ç³»ï¼ˆã€œãªã‚“ã ã‚ˆï¼ï¼ã€œã ã£ã¦ï¼ï¼‰\nã€€ç· ã‚ç³»ï¼ˆã€œã—ã‚ˆã†ï¼ã€œã—ã¦ã¿ã¦ï¼ã€œã ã­ï¼‰\nãƒ»è¦ªã—ã¿ã‚„ã™ãã€ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªãƒˆãƒ¼ãƒ³ã§' + charCountGuide;
        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä¸åœ¨ãƒ‘ãƒãƒ«ã®ãƒ«ãƒ¼ãƒ«ã‚’ä½œæˆ
        var absentPanelRule = '';
        if (charAbsentCount === 0) {
          absentPanelRule = '\n\nã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä¸åœ¨ãƒ‘ãƒãƒ«ã€‘\nâ–  Character-Absent Panel Requirement:\nâš ï¸ CRITICAL: DO NOT include any character-absent panels\n- ALL 4 panels MUST show characters\n- Every panel must have the character(s) visible and present\n- Do NOT create panels with only backgrounds, diagrams, infographics, or objects\n- Do NOT create concept visualization panels\n- Do NOT create landscape-only panels\n- Characters must appear in ALL FOUR panels without exception\n\nãƒ»ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä¸åœ¨ãƒ‘ãƒãƒ«ã¯ä¸€åˆ‡ä¸è¦ã§ã™\nãƒ»å…¨4ãƒ‘ãƒãƒ«ã«å¿…ãšã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ç™»å ´ã•ã›ã¦ãã ã•ã„\nãƒ»èƒŒæ™¯ã®ã¿ã€å›³è§£ã®ã¿ã€ç‰©ã®ã¿ã®ãƒ‘ãƒãƒ«ã¯ä½œæˆç¦æ­¢ã§ã™\nãƒ»4ã‚³ãƒå…¨ã¦ã«ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒç™»å ´ã—ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™';
        } else if (charAbsentCount === 1) {
          absentPanelRule = '\n\nã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä¸åœ¨ãƒ‘ãƒãƒ«ã€‘\nâ–  Character-Absent Panel Requirement:\n- MUST include exactly 1 character-absent panel (no more, no less)\n- Character-present panels: 3 panels\n- Character-absent panels: 1 panel\n- These panels tell the story visually without characters\n- NO speech bubbles in character-absent panels\n- Include title/heading (10 characters max) using story keywords\n- Reflect specific story content, NOT generic imagery\n\nãƒ»ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç™»å ´ãƒ‘ãƒãƒ«ï¼š3ãƒ‘ãƒãƒ«\nãƒ»ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä¸åœ¨ãƒ‘ãƒãƒ«ï¼š1ãƒ‘ãƒãƒ«ï¼ˆå¿…é ˆï¼‰\nãƒ»ä¸åœ¨ãƒ‘ãƒãƒ«ã§ã¯å›³è§£ãƒ»ã‚¤ãƒ¡ãƒ¼ã‚¸ç­‰ã§ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’è¦–è¦šçš„ã«è¡¨ç¾';
        } else if (charAbsentCount === 2) {
          absentPanelRule = '\n\nã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä¸åœ¨ãƒ‘ãƒãƒ«ã€‘\nâ–  Character-Absent Panel Requirement:\n- MUST include exactly 2 character-absent panels (no more, no less)\n- Character-present panels: 2 panels\n- Character-absent panels: 2 panels\n- These panels tell the story visually without characters\n- NO speech bubbles in character-absent panels\n- Include title/heading (10 characters max) using story keywords\n- Reflect specific story content, NOT generic imagery\n\nãƒ»ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç™»å ´ãƒ‘ãƒãƒ«ï¼š2ãƒ‘ãƒãƒ«\nãƒ»ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä¸åœ¨ãƒ‘ãƒãƒ«ï¼š2ãƒ‘ãƒãƒ«ï¼ˆå¿…é ˆï¼‰\nãƒ»ä¸åœ¨ãƒ‘ãƒãƒ«ã§ã¯å›³è§£ãƒ»ã‚¤ãƒ¡ãƒ¼ã‚¸ç­‰ã§ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’è¦–è¦šçš„ã«è¡¨ç¾';
        }

        var charRule = hasC
          ? 'ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼äººæ•°ãƒ«ãƒ¼ãƒ«ã€‘\nãƒ»ãƒ¡ã‚¤ãƒ³ã®ç™»å ´äººç‰©ã¯2äººï¼ˆãƒ‡ã‚¶ã‚¤ãƒ³ã¯å‚è€ƒç”»åƒã«å¾“ã†ï¼‰\nãƒ»1æšç›®ã®ç”»åƒã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ï¼šèª¬æ˜å½¹\nãƒ»2æšç›®ã®ç”»åƒã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ï¼šç›¸è«‡è€…å½¹\nãƒ»ç›¸è«‡è€…ã¯çµ¶å¯¾ã«èª¬æ˜ã‚’ã•ã›ãªã„ã§ãã ã•ã„\nãƒ»èƒŒæ™¯å†…ã®èª¬æ˜ç”¨ã‚¤ãƒ¡ãƒ¼ã‚¸äººç‰©ï¼ˆæ­´å²çš„äººç‰©ãªã©ï¼‰ã¯åˆ¥æ‰±ã„\n\nã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç™»å ´ãƒ«ãƒ¼ãƒ«ã€‘\nãƒ»1ã‚³ãƒã«2äººãŒç™»å ´ã—ãªãã¦ã‚‚ã„ã„\nãƒ»1ã‚³ãƒã«èª¬æ˜è€…ã®ã¿ã€ç›¸è«‡è€…ã®ã¿ã§ã‚‚ã„ã„' + absentPanelRule
          : 'ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼äººæ•°ãƒ«ãƒ¼ãƒ«ã€‘\nãƒ»ç™»å ´äººç‰©ã¯1äººã®ã¿ï¼ˆå‚è€ƒç”»åƒã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ï¼‰\nãƒ»èª­è€…ã«èªã‚Šã‹ã‘ã‚‹å½¢å¼ã§é€²è¡Œ\nãƒ»ç‹¬ç™½ãƒ»èª¬æ˜å½¢å¼ã§å†…å®¹ã‚’ä¼ãˆã‚‹' + absentPanelRule;
        var charCountText = hasC ? '2äººã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼' : '1äººã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼';

        // ã‚µãƒ–ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æŒ‡ç¤º
        var subCharInstructions = enableSubChars
          ? '\n\nâš ï¸ SUPPORTING CHARACTER GENERATION:\n\nâ–  Additional Characters in Story:\n- If the story mentions additional characters (customers, clerks, friends, family members, etc.), you MUST include them in the manga\n- Generate these supporting characters appropriately based on their role in the story\n- Examples: If story mentions "ãŠå®¢æ§˜" (customer), create a customer character and show them in conversation panels\n- Supporting characters should be designed to fit the story context (e.g., business customer in suit, cafe customer in casual clothes)\n- Maintain consistency of supporting characters across panels if they appear multiple times\n\nâ–  Supporting Character Design:\n- Create supporting characters that are DISTINCT from main characters (different appearance, clothing, hairstyle)\n- Supporting characters should look realistic for their role (customers, staff, strangers, etc.)\n- Use appropriate age, gender, and appearance based on story context\n- Supporting characters can have simpler designs than main characters but must be clearly visible\n\nâ–  Interaction Panels:\n- When main characters talk to supporting characters, show BOTH in the same panel\n- Use appropriate camera angles to show conversation (e.g., over-the-shoulder shots, two-shot compositions)\n- Speech bubbles should clearly indicate who is speaking\n- Supporting characters can have dialogue as specified in the story\n\nâ–  Examples:\n- Story: "ï¼ˆãŠå®¢æ§˜ï¼‰ã€Œç„¡æ–™ã ã¨æ€ã£ã¦ã¾ã—ãŸã€" â†’ Show a customer character speaking this line, with main character also visible\n- Story: "åº—å“¡ã«èã„ã¦ã¿ãŸ" â†’ Include a staff/clerk character in that panel\n- Story: "å‹äººã¨è©±ã—ã¦ã„ãŸ" â†’ Show the friend character alongside main character'
          : '';

        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è©³ç´°æƒ…å ±ã‚’è¿½åŠ 
        var charDetailText = '';
        var hasDetails = false;
        for (var i = 0; i < 4; i++) {
          if (selChars[i] && (charDetails[i].name || charDetails[i].features)) {
            hasDetails = true;
            var roleName = i === 0 ? 'èª¬æ˜è€… (Explainer)' : i === 1 ? 'ç›¸è«‡è€… (Questioner)' : 'å‚è€ƒ' + (i + 1);
            charDetailText += '\n- ' + roleName + ':';
            if (charDetails[i].name) charDetailText += ' åå‰: ' + charDetails[i].name;
            if (charDetails[i].features) charDetailText += ' | ç‰¹å¾´: ' + charDetails[i].features;
          }
        }
        if (hasDetails) {
          charDetailText = '\n\nâ–  Additional Character Details (å‚è€ƒæƒ…å ±):\nUse the following details to enhance character accuracy:' + charDetailText + '\n';
        }

        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å¤–è¦‹ã®è©³ç´°æŒ‡ç¤ºã‚’ä½œæˆ
        var charDesc = hasC
          ? 'âš ï¸ CRITICAL CHARACTER REFERENCE IMAGE REQUIREMENT - HIGHEST PRIORITY:\n\nâ–  Reference Image Order:\n- 1st image: Main Explainer character (èª¬æ˜è€…)\n- 2nd image: Questioner character (ç›¸è«‡è€…)\n' + (selChars[2] ? '- 3rd image: Additional reference\n' : '') + (selChars[3] ? '- 4th image: Additional reference\n' : '') + charDetailText + '\nâ–  Character Reproduction Requirement:\nYou MUST reproduce the character design from reference images with 100% FIDELITY:\n- Facial features: Face shape, eye shape, eye color, nose, mouth - EXACTLY as shown\n- Hairstyle: Hair length, style, bangs, volume - EXACTLY as shown\n- Hair color: Exact color shade, highlights, gradients - EXACTLY as shown\n- Clothing: Style, color, patterns, accessories - EXACTLY as shown\n- Body proportions: Height, build, posture - EXACTLY as shown\n- Art style: Line weight, coloring technique, shading style - EXACTLY as shown\n\nâ–  Critical Instructions:\n- DO NOT modify or "improve" the character design\n- DO NOT change clothing between panels unless story requires it\n- DO NOT add or remove accessories\n- The reference images define the ABSOLUTE visual identity\n- Any deviation from reference images is considered a critical error\n- Maintain PERFECT consistency across all 4 panels\n\nâ–  Character Role Distribution:\n- Explainer (1st image character): ~70% of dialogue, provides main information\n- Questioner (2nd image character): ~30% of dialogue, asks questions and responds\n- Both characters must maintain their exact appearance from reference images throughout' + subCharInstructions
          : 'âš ï¸ CRITICAL CHARACTER REFERENCE IMAGE REQUIREMENT - HIGHEST PRIORITY:\n\nâ–  Reference Image:\n- 1st image: The main character (ç™»å ´äººç‰©)\n' + (selChars[2] ? '- 2nd image: Additional reference\n' : '') + (selChars[3] ? '- 3rd image: Additional reference\n' : '') + charDetailText + '\nâ–  Character Reproduction Requirement:\nYou MUST reproduce the character design from the reference image with 100% FIDELITY:\n- Facial features: Face shape, eye shape, eye color, nose, mouth - EXACTLY as shown\n- Hairstyle: Hair length, style, bangs, volume - EXACTLY as shown\n- Hair color: Exact color shade, highlights, gradients - EXACTLY as shown\n- Clothing: Style, color, patterns, accessories - EXACTLY as shown\n- Body proportions: Height, build, posture - EXACTLY as shown\n- Art style: Line weight, coloring technique, shading style - EXACTLY as shown\n\nâ–  Critical Instructions:\n- DO NOT modify or "improve" the character design\n- DO NOT change clothing between panels unless story requires it\n- DO NOT add or remove accessories\n- The reference image defines the ABSOLUTE visual identity\n- Any deviation from reference image is considered a critical error\n- Maintain PERFECT consistency across all 4 panels\n- This character speaks directly to the reader in explanatory style' + subCharInstructions;

        // ã‚«ã‚¹ã‚¿ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæƒ…å ±ã‚’æŠ½å‡º
        var panels = extractPanelInfo(story);
        var customLayout = panels.length > 0 ? generateLayoutInstructions(panels) : '';

        return {
          STORY: story,
          STYLE_PROMPT: spt,
          SPEECH_STYLE: spch,
          CHARACTER_RULE: charRule,
          CHARACTER_COUNT: charCountText,
          CHARACTER_DESCRIPTION: charDesc,
          CUSTOM_LAYOUT: customLayout,
          PANEL_COUNT: panels.length > 0 ? panels.length.toString() : '4'
        };
      }

      // å˜ä¸€ã‚¹ãƒ†ãƒƒãƒ—ã®å®Ÿè¡Œ
      function executeStep(stepIndex, stepOutputs) {
        var step = promptSteps[stepIndex];
        var commonVars = getCommonVars();

        // å¤‰æ•°ãƒãƒƒãƒ—ã‚’ä½œæˆ
        var vars = Object.assign({}, commonVars);

        // å‰ã‚¹ãƒ†ãƒƒãƒ—ã®å‡ºåŠ›ã‚’è¿½åŠ 
        if (stepIndex > 0) {
          vars.PREV_OUTPUT = stepOutputs[stepIndex - 1] || '';
        }

        // å„ã‚¹ãƒ†ãƒƒãƒ—ã®å‡ºåŠ›ã‚’è¿½åŠ 
        stepOutputs.forEach(function(output, idx) {
          vars['STEP' + (idx + 1) + '_OUTPUT'] = output;
        });

        // æœ€çµ‚ã‚¹ãƒ†ãƒƒãƒ—ã®å‡ºåŠ›ã‚’è¿½åŠ 
        if (stepOutputs.length > 0) {
          vars.GENERATED_PROMPT = stepOutputs[stepOutputs.length - 1];
        }

        var promptText = replaceVars(step.template, vars);
        console.log('===== Step ' + (stepIndex + 1) + ': ' + step.name + ' =====');
        console.log(promptText);

        if (step.type === 'image') {
          // ç”»åƒç”Ÿæˆ
          return executeImageGeneration(promptText);
        } else {
          // ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ
          return executeTextGeneration(promptText);
        }
      }

      // ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ
      function executeTextGeneration(promptText) {
        var body = {
          contents: [{ parts: [{ text: promptText }] }]
        };

        return fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=' + apiKey, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        })
        .then(function(res) {
          if (!res.ok) return res.json().then(function(err) { throw new Error(err.error ? err.error.message : 'Text API error'); });
          return res.json();
        })
        .then(function(data) {
          var txt = '';
          if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts) {
            txt = data.candidates[0].content.parts[0].text || '';
          }
          console.log('ç”Ÿæˆçµæœ:', txt.substring(0, 200) + '...');
          return txt;
        });
      }

      // ç”»åƒç”Ÿæˆ
      function executeImageGeneration(promptText) {
        var m = MODELS.find(function(x) { return x.id === model; });
        var parts = [];

        selChars.forEach(function(c) {
          if (c && c.img) {
            var b = c.img.split(',')[1];
            parts.push({ inlineData: { mimeType: 'image/png', data: b } });
          }
        });
        if (style === 99 && styleRef && styleRef.img) {
          var b = styleRef.img.split(',')[1];
          parts.push({ inlineData: { mimeType: 'image/png', data: b } });
        }

        var body = {
          system_instruction: { parts: [{ text: promptText }] },
          contents: [{ parts: parts }],
          generationConfig: {
            responseModalities: ['IMAGE'],
            temperature: 0.4,      // ä¸€è²«æ€§é‡è¦–ï¼šä½ã‚ã«è¨­å®šï¼ˆ0.3-0.5æ¨å¥¨ï¼‰
            topP: 0.85,           // ã‚ˆã‚Šäºˆæ¸¬å¯èƒ½ãªå‡ºåŠ›
            topK: 40,             // å€™è£œã‚’çµã‚‹
            candidateCount: 1     // 1ã¤ã®çµæœã®ã¿ç”Ÿæˆ
          }
        };

        return fetch('https://generativelanguage.googleapis.com/v1beta/models/' + m.model + ':generateContent?key=' + apiKey, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        })
        .then(function(res) {
          if (!res.ok) return res.json().then(function(err) { throw new Error(err.error ? err.error.message : 'Image API error'); });
          return res.json();
        })
        .then(function(data) {
          var img = null;
          if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts) {
            data.candidates[0].content.parts.forEach(function(p) {
              if (p.inlineData) img = 'data:' + p.inlineData.mimeType + ';base64,' + p.inlineData.data;
            });
          }
          return img;
        });
      }

      // ãƒ¡ã‚¤ãƒ³ç”Ÿæˆé–¢æ•°ï¼ˆè¤‡æ•°ã‚¹ãƒ†ãƒƒãƒ—å¯¾å¿œï¼‰
      function generate() {
        if (!apiKey) { setError('APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„'); return; }
        if (!selChars[0]) { setError('èª¬æ˜è€…ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
        if (!story || story.length < 20) { setError('20æ–‡å­—ä»¥ä¸Šå…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
        if (promptSteps.length === 0) { setError('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“'); return; }

        setIsGen(true);
        setError('');
        setGenImages([]);
        setCurImg(0);
        cancelRef.current = false;
        setCurrentStep(0);

        var m = MODELS.find(function(x) { return x.id === model; });
        var currentImages = new Array(genCount);  // å›ºå®šã‚µã‚¤ã‚ºé…åˆ—ã§ä¸¦åˆ—å®Ÿè¡Œã«å¯¾å¿œ

        function generateOne(imgIndex) {
          if (cancelRef.current) {
            return Promise.reject(new Error('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ'));
          }
          setGenIdx(imgIndex);

          var stepOutputs = [];
          var finalOutput = null;  // æœ€çµ‚çš„ãªç”»åƒå‡ºåŠ›ã‚’ä¿æŒ

          function executeSteps(stepIndex) {
            if (stepIndex >= promptSteps.length || cancelRef.current) {
              if (cancelRef.current) throw new Error('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
              return Promise.resolve();
            }

            setCurrentStep(stepIndex + 1);

            return executeStep(stepIndex, stepOutputs)
              .then(function(output) {
                if (promptSteps[stepIndex].type === 'image') {
                  // ç”»åƒç”Ÿæˆã®å ´åˆã€çµæœã‚’ä¿å­˜
                  if (!output) throw new Error('ç”»åƒã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');

                  finalOutput = output;  // æœ€çµ‚å‡ºåŠ›ã‚’ä¿å­˜
                  currentImages[imgIndex] = output;
                  var completedImages = currentImages.filter(function(img) { return img !== undefined; });
                  setGenImages(completedImages);
                  setCurImg(completedImages.length - 1);

                  // ç”»åƒã‚’åœ§ç¸®ã—ã¦å±¥æ­´ã«ä¿å­˜ï¼ˆæœ€å¤§å¹…400pxã€å“è³ª0.6ã§ä¸­ç¨‹åº¦åœ§ç¸®ï¼‰
                  compressImage(output, 400, 0.6).then(function(compressedImg) {
                    var st = STYLES.find(function(s) { return s.id === style; });
                    var hi = { id: 'g_' + Date.now() + '_' + imgIndex, img: compressedImg, settings: { style: style, styleName: st ? st.name : '', speech: speech, model: model, modelName: m.name, story: story.substring(0, 80) + '...' }, ts: new Date().toISOString() };

                    try {
                      var savedHist = localStorage.getItem('manga_history');
                      var histArr = savedHist ? JSON.parse(savedHist) : [];
                      histArr.unshift(hi);
                      if (histArr.length > 10) histArr = histArr.slice(0, 10);
                      localStorage.setItem('manga_history', JSON.stringify(histArr));
                      setHistory(histArr);
                    } catch(e) {
                      // QuotaExceededErrorå¯¾ç­–: å¤ã„å±¥æ­´ã‚’å‰Šé™¤ã—ã¦å†è©¦è¡Œ
                      if (e.name === 'QuotaExceededError') {
                        console.warn('å®¹é‡è¶…é: å±¥æ­´ã‚’5ä»¶ã«å‰Šæ¸›ã—ã¦å†è©¦è¡Œ');
                        try {
                          var reducedHist = [hi].concat(histArr.slice(0, 4));
                          localStorage.setItem('manga_history', JSON.stringify(reducedHist));
                          setHistory(reducedHist);
                        } catch(e2) {
                          // ãã‚Œã§ã‚‚å¤±æ•—ã—ãŸã‚‰å±¥æ­´ã‚’å®Œå…¨ã‚¯ãƒªã‚¢
                          console.error('å±¥æ­´ä¿å­˜å¤±æ•—: å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™');
                          localStorage.setItem('manga_history', JSON.stringify([hi]));
                          setHistory([hi]);
                          alert('å±¥æ­´ã®å®¹é‡ãŒé™ç•Œã«é”ã—ãŸãŸã‚ã€å¤ã„å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
                        }
                      } else {
                        console.error('å±¥æ­´ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
                      }
                    }

                    // ä½¿ç”¨é‡è¨˜éŒ²
                    try {
                      var now = new Date();
                      var mk = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
                      var savedUsage = localStorage.getItem('manga_usage');
                      var usageData = savedUsage ? JSON.parse(savedUsage) : { monthly: [], total: { count: 0, cost: 0 } };
                      if (!usageData.monthly) usageData.monthly = [];
                      var md = usageData.monthly.find(function(x) { return x.month === mk; });
                      if (!md) { md = { month: mk, items: [] }; usageData.monthly.push(md); }
                      md.items.push({ date: now.toISOString(), model: model, price: m.price });
                      usageData.total.count = (usageData.total.count || 0) + 1;
                      usageData.total.cost = (usageData.total.cost || 0) + m.price;
                      localStorage.setItem('manga_usage', JSON.stringify(usageData));
                      setUsage(usageData);
                    } catch(e) {
                      console.error('ä½¿ç”¨é‡è¨˜éŒ²ã‚¨ãƒ©ãƒ¼:', e);
                    }
                  }).catch(function(e) {
                    console.error('ç”»åƒåœ§ç¸®ã‚¨ãƒ©ãƒ¼:', e);
                  });
                } else {
                  // ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆã®å ´åˆã€æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã®å…¥åŠ›ã¨ã—ã¦ä¿å­˜
                  stepOutputs.push(output);
                }

                return executeSteps(stepIndex + 1);
              });
          }

          return executeSteps(0)
            .then(function() {
              setCurrentStep(0);
              return finalOutput;  // å®Œäº†ã—ãŸç”»åƒã‚’è¿”ã™
            })
            .catch(function(e) {
              console.error('ç”»åƒ' + (imgIndex + 1) + 'ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', e);
              throw e;
            });
        }

        // ä¸¦åˆ—ç”Ÿæˆ: å…¨ã¦ã®ç”»åƒã‚’åŒæ™‚ã«ç”Ÿæˆ
        var promises = [];
        for (var i = 0; i < genCount; i++) {
          promises.push(generateOne(i));
        }

        Promise.all(promises)
          .then(function() {
            setIsGen(false);
            setCurrentStep(0);
            console.log('å…¨' + genCount + 'æšã®ç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸ');
          })
          .catch(function(e) {
            setError('ã‚¨ãƒ©ãƒ¼: ' + e.message);
            setIsGen(false);
            setCurrentStep(0);
          });
      }

      function dl(img, i) {
        var a = document.createElement('a');
        a.href = img;
        a.download = 'manga_' + Date.now() + '_' + (i + 1) + '.png';
        a.click();
      }

      function toggleFavHist(id) {
        var nf = favHist.indexOf(id) >= 0 ? favHist.filter(function(x) { return x !== id; }) : favHist.concat([id]);
        setFavHist(nf);
        localStorage.setItem('manga_fav_hist', JSON.stringify(nf));
      }

      function saveProj() {
        if (!newProjName) return;
        var p = { id: 'p_' + Date.now(), name: newProjName, settings: { selChars: selChars, style: style, styleRef: styleRef, speech: speech, model: model, charAbsentCount: charAbsentCount, enableSubChars: enableSubChars }, ts: new Date().toISOString() };
        var np = projects.concat([p]);
        setProjects(np);
        localStorage.setItem('manga_projects', JSON.stringify(np));
        setCurProj(p);
        setShowAddProj(false);
        setNewProjName('');
      }

      function loadProj(p) {
        var s = p.settings;
        if (s.selChars) setSelChars(s.selChars);
        if (s.style) setStyle(s.style);
        if (s.styleRef) setStyleRef(s.styleRef);
        if (s.speech) setSpeech(s.speech);
        if (s.model) setModel(s.model);
        if (s.charAbsentCount !== undefined) setCharAbsentCount(s.charAbsentCount);
        if (s.enableSubChars !== undefined) setEnableSubChars(s.enableSubChars);
        setCurProj(p);
      }

      function delProj(id) {
        if (!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
        var np = projects.filter(function(p) { return p.id !== id; });
        setProjects(np);
        localStorage.setItem('manga_projects', JSON.stringify(np));
        if (curProj && curProj.id === id) setCurProj(null);
      }

      function clearProj() {
        setCurProj(null);
      }

      function exportProj(p) {
        var json = JSON.stringify(p, null, 2);
        var blob = new Blob([json], { type: 'application/json' });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = 'project_' + p.name + '_' + Date.now() + '.json';
        a.click();
        URL.revokeObjectURL(url);
      }

      function importProj() {
        var input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = function(e) {
          var file = e.target.files[0];
          if (!file) return;
          var reader = new FileReader();
          reader.onload = function(ev) {
            try {
              var imported = JSON.parse(ev.target.result);
              imported.id = 'p_' + Date.now();
              imported.name = imported.name + ' (ã‚¤ãƒ³ãƒãƒ¼ãƒˆ)';
              var np = projects.concat([imported]);
              setProjects(np);
              localStorage.setItem('manga_projects', JSON.stringify(np));
              alert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
            } catch(e) {
              alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
          };
          reader.readAsText(file);
        };
        input.click();
      }

      function compTut() { localStorage.setItem('manga_tut_seen', '1'); setShowTut(false); setTutStep(0); }
      function togAccord(k) { setAccord(accord.indexOf(k) >= 0 ? accord.filter(function(x) { return x !== k; }) : accord.concat([k])); }

      var sortedStyles = STYLES.slice().sort(function(a, b) {
        var aF = favStyles.indexOf(a.id) >= 0, bF = favStyles.indexOf(b.id) >= 0;
        return aF && !bF ? -1 : !aF && bF ? 1 : 0;
      });

      function calcUsage() {
        var now = new Date();
        var mk = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
        var md = usage.monthly ? usage.monthly.find(function(m) { return m.month === mk; }) : null;
        if (!md || !md.items) return { count: 0, cost: 0, by: {} };
        var by = {}, cost = 0;
        md.items.forEach(function(item) {
          if (!by[item.model]) by[item.model] = { count: 0, cost: 0 };
          by[item.model].count++;
          by[item.model].cost += item.price;
          cost += item.price;
        });
        return { count: md.items.length, cost: cost, by: by };
      }
      var mu = calcUsage();

      function est() {
        var m = MODELS.find(function(x) { return x.id === model; });
        return { usd: (m.price * genCount).toFixed(2), jpy: Math.round(m.jpy * genCount) };
      }

      return html`
        <div class="flex min-h-screen">
          ${sidebar && html`<div class="md:hidden fixed inset-0 bg-black/50 z-40" onClick=${function() { setSidebar(false); }}></div>`}
          
          <div class="sidebar w-96 bg-white border-r p-5 overflow-y-auto flex-shrink-0 ${sidebar ? 'open' : ''}">
            <div class="flex items-center justify-between mb-6">
              <h1 class="text-xl font-bold text-gray-800">æ¼«ç”»ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼</h1>
              <button class="md:hidden text-gray-500 text-2xl" onClick=${function() { setSidebar(false); }}>Ã—</button>
            </div>

            <div class="flex gap-2 mb-6 text-sm">
              <button onClick=${function() { setShowTut(true); }} class="text-blue-500 hover:underline">ä½¿ã„æ–¹</button>
              <span class="text-gray-300">|</span>
              <button onClick=${function() { setShowSamp(true); }} class="text-blue-500 hover:underline">ã‚µãƒ³ãƒ—ãƒ«</button>
              <span class="text-gray-300">|</span>
              <button onClick=${function() { setShowUsage(true); }} class="text-blue-500 hover:underline">ä½¿ç”¨é‡</button>
            </div>

            <div class="mb-4 p-4 bg-gray-50 rounded-lg">
              <div class="flex items-center mb-3">
                <span class="text-sm font-semibold text-gray-700">APIè¨­å®š</span>
                <${HelpIcon} text=${HELP.api} />
              </div>
              <div class="relative mb-2">
                <input type=${showApi ? 'text' : 'password'} value=${apiKey} onInput=${function(e) { setApiKey(e.target.value); setApiSaved(false); }} placeholder="APIã‚­ãƒ¼ã‚’å…¥åŠ›" class="w-full px-3 py-2 pr-16 border rounded-lg text-sm" />
                <button onClick=${function() { setShowApi(!showApi); }} class="absolute right-2 top-1/2 -translate-y-1/2 text-xs text-gray-500">${showApi ? 'éš ã™' : 'è¡¨ç¤º'}</button>
              </div>
              <button onClick=${saveApi} class="w-full py-2 bg-blue-500 text-white text-sm rounded-lg hover:bg-blue-600">ä¿å­˜</button>
              <div class="mt-2 text-xs ${apiSaved ? 'text-green-600' : 'text-amber-600'}">${apiSaved ? 'ä¿å­˜æ¸ˆã¿' : 'æœªä¿å­˜'}</div>
            </div>

            <div class="mb-4">
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-semibold text-gray-700">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</span>
                <div class="flex gap-1">
                  ${curProj && html`<button onClick=${clearProj} class="text-xs text-gray-500 hover:text-gray-700" title="é¸æŠè§£é™¤">è§£é™¤</button>`}
                  <button onClick=${importProj} class="text-xs text-blue-500 hover:text-blue-700" title="ã‚¤ãƒ³ãƒãƒ¼ãƒˆ">â†“</button>
                </div>
              </div>
              <div class="flex gap-2 overflow-x-auto pb-2 scrollbar-thin">
                ${projects.map(function(p) {
                  return html`
                    <div key=${p.id} class="relative flex-shrink-0 group">
                      <button
                        onClick=${function() { loadProj(p); }}
                        class="px-3 py-2 text-xs rounded-lg border ${curProj && curProj.id === p.id ? 'border-blue-500 bg-blue-50' : 'border-gray-300 hover:bg-gray-50'}"
                      >
                        ${p.name}
                      </button>
                      <div class="absolute -top-1 -right-1 hidden group-hover:flex gap-1">
                        <button
                          onClick=${function(e) { e.stopPropagation(); exportProj(p); }}
                          class="w-4 h-4 bg-green-500 text-white rounded-full text-xs flex items-center justify-center hover:bg-green-600"
                          title="ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ"
                        >â†‘</button>
                        <button
                          onClick=${function(e) { e.stopPropagation(); delProj(p.id); }}
                          class="w-4 h-4 bg-red-500 text-white rounded-full text-xs flex items-center justify-center hover:bg-red-600"
                          title="å‰Šé™¤"
                        >Ã—</button>
                      </div>
                    </div>
                  `;
                })}
                <button onClick=${function() { setShowAddProj(true); }} class="flex-shrink-0 px-3 py-2 text-xs rounded-lg border border-dashed border-gray-300 text-gray-400 hover:bg-gray-50">+ æ–°è¦</button>
              </div>
            </div>

            <div class="mb-4">
              <button onClick=${function() { togAccord('lib'); }} class="flex items-center justify-between w-full text-left">
                <span class="text-sm font-semibold text-gray-700">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒª</span>
                <span class="text-gray-400">${accord.indexOf('lib') >= 0 ? 'â–¼' : 'â–¶'}</span>
              </button>
              <div class="accordion-content ${accord.indexOf('lib') >= 0 ? 'open' : ''}">
                <div class="flex gap-2 overflow-x-auto py-2 scrollbar-thin">
                  ${chars.map(function(c) { return html`<div key=${c.id} class="flex-shrink-0 w-14 cursor-pointer" onContextMenu=${function(e) { e.preventDefault(); delChar(c.id); }}><img src=${c.img} class="w-14 h-14 object-cover rounded-lg border-2 border-gray-200 hover:border-blue-400" onClick=${function() { var idx = selChars.findIndex(function(x) { return x === null; }); if (idx >= 0) { var nc = selChars.slice(); nc[idx] = c; setSelChars(nc); } }} /><div class="text-xs text-center mt-1 truncate">${c.name}</div></div>`; })}
                  <button onClick=${function() { setShowAddChar(true); }} class="flex-shrink-0 w-14 h-14 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center text-gray-400">+</button>
                </div>
              </div>
            </div>

            <div class="mb-4">
              <button onClick=${function() { togAccord('char'); }} class="flex items-center justify-between w-full text-left">
                <div class="flex items-center"><span class="text-sm font-semibold text-gray-700">ä»Šå›ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼</span><${HelpIcon} text=${HELP.character} /></div>
                <span class="text-gray-400">${accord.indexOf('char') >= 0 ? 'â–¼' : 'â–¶'}</span>
              </button>
              <div class="accordion-content ${accord.indexOf('char') >= 0 ? 'open' : ''}">
                <div class="grid grid-cols-4 gap-2 py-2">
                  ${['èª¬æ˜è€…*', 'ç›¸è«‡è€…', 'å‚è€ƒ3', 'å‚è€ƒ4'].map(function(label, idx) { return html`<div key=${idx} class="border-2 ${selChars[idx] ? 'border-blue-400' : 'border-dashed border-gray-300'} rounded-lg p-1"><div class="text-xs text-gray-500 text-center mb-1">${label}</div>${selChars[idx] ? html`<div><div class="relative cursor-pointer" onClick=${function() { openCharDetail(idx); }}><img src=${selChars[idx].img} class="w-full h-14 object-cover rounded" /><button onClick=${function(e) { e.stopPropagation(); var nc = selChars.slice(); nc[idx] = null; setSelChars(nc); }} class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 text-white rounded-full text-xs">Ã—</button></div><button onClick=${function() { openCharDetail(idx); }} class="text-xs text-blue-500 mt-1 hover:text-blue-600 w-full text-center">è©³ç´°ã‚’ç·¨é›†</button></div>` : html`<div class="h-14 flex items-center justify-center bg-gray-50 rounded cursor-pointer hover:bg-gray-100" onClick=${function() { charRefs.current[idx] && charRefs.current[idx].click(); }}><span class="text-gray-400 text-xs">+</span></div>`}<input ref=${function(el) { charRefs.current[idx] = el; }} type="file" accept="image/*" class="hidden" onChange=${function(e) { handleFile(e, idx); }} /></div>`; })}
                </div>
              </div>
            </div>

            <div class="mb-4">
              <button onClick=${function() { togAccord('style'); }} class="flex items-center justify-between w-full text-left">
                <div class="flex items-center"><span class="text-sm font-semibold text-gray-700">çµµã®ãƒ†ã‚¤ã‚¹ãƒˆ</span><${HelpIcon} text=${HELP.style} /></div>
                <span class="text-gray-400">${accord.indexOf('style') >= 0 ? 'â–¼' : 'â–¶'}</span>
              </button>
              <div class="accordion-content ${accord.indexOf('style') >= 0 ? 'open' : ''}">
                <div class="max-h-48 overflow-y-auto py-2 scrollbar-thin">
                  ${sortedStyles.map(function(s) { return html`<label key=${s.id} class="flex items-center p-2 rounded-lg cursor-pointer ${style === s.id ? 'bg-blue-50 border-l-4 border-blue-500' : 'hover:bg-gray-50'}"><input type="radio" name="style" checked=${style === s.id} onChange=${function() { setStyle(s.id); }} class="mr-2" /><div class="flex-1"><div class="text-sm">${s.name}</div><div class="text-xs text-gray-500">${s.desc}</div></div>${s.id !== 99 && html`<button onClick=${function(e) { e.preventDefault(); toggleFavStyle(s.id); }} class="${favStyles.indexOf(s.id) >= 0 ? 'text-yellow-500' : 'text-gray-300'}">${favStyles.indexOf(s.id) >= 0 ? 'â˜…' : 'â˜†'}</button>`}</label>`; })}
                </div>
                ${style === 99 && html`<div class="mt-2 p-2 border border-dashed rounded-lg"><div class="text-xs text-gray-500 mb-2">å‚ç…§ç”»åƒ</div>${styleRef ? html`<div class="relative inline-block"><img src=${styleRef.img} class="h-16 rounded" /><button onClick=${function() { setStyleRef(null); }} class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 text-white rounded-full text-xs">Ã—</button></div>` : html`<button onClick=${function() { styleRefInput.current && styleRefInput.current.click(); }} class="text-sm text-blue-500">+ ç”»åƒé¸æŠ</button>`}<input ref=${styleRefInput} type="file" accept="image/*" class="hidden" onChange=${function(e) { var f = e.target.files[0]; if (!f) return; var r = new FileReader(); r.onload = function(ev) { setStyleRef({ img: ev.target.result }); }; r.readAsDataURL(f); }} /></div>`}
              </div>
            </div>


            <div class="mb-4">
              <button onClick=${function() { togAccord('model'); }} class="flex items-center justify-between w-full text-left">
                <div class="flex items-center"><span class="text-sm font-semibold text-gray-700">ãƒ¢ãƒ‡ãƒ«é¸æŠ</span><${HelpIcon} text=${HELP.model} /></div>
                <span class="text-gray-400">${accord.indexOf('model') >= 0 ? 'â–¼' : 'â–¶'}</span>
              </button>
              <div class="accordion-content ${accord.indexOf('model') >= 0 ? 'open' : ''}">
                <div class="space-y-1 py-2">
                  ${MODELS.map(function(m) { return html`<label key=${m.id} class="flex items-center p-2 rounded-lg cursor-pointer ${model === m.id ? 'bg-blue-50' : 'hover:bg-gray-50'}"><input type="radio" checked=${model === m.id} onChange=${function() { setModel(m.id); }} class="mr-2" /><div class="flex-1"><div class="text-sm">${m.name}</div><div class="text-xs text-gray-500">${m.price > 0 ? '$' + m.price + '/æš' : 'ç„¡æ–™'}</div></div></label>`; })}
                </div>
              </div>
            </div>

            <div class="mb-4">
              <button onClick=${function() { togAccord('genmode'); }} class="flex items-center justify-between w-full text-left">
                <div class="flex items-center"><span class="text-sm font-semibold text-gray-700">ç”Ÿæˆãƒ¢ãƒ¼ãƒ‰</span></div>
                <span class="text-gray-400">${accord.indexOf('genmode') >= 0 ? 'â–¼' : 'â–¶'}</span>
              </button>
              <div class="accordion-content ${accord.indexOf('genmode') >= 0 ? 'open' : ''}">
                <div class="space-y-2 py-2">
                  <button
                    onClick=${function() {
                      setGenMode('simple');
                      localStorage.setItem('manga_gen_mode', 'simple');
                    }}
                    class="w-full p-3 rounded-lg border-2 text-left ${genMode === 'simple' ? 'border-blue-500 bg-blue-50' : 'border-gray-300 hover:bg-gray-50'}"
                  >
                    <div class="font-semibold text-sm">ç°¡æ˜“ãƒ¢ãƒ¼ãƒ‰</div>
                    <div class="text-xs text-gray-600 mt-1">1ã‚¹ãƒ†ãƒƒãƒ—ã§é«˜é€Ÿç”Ÿæˆï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰</div>
                  </button>
                  <button
                    onClick=${function() {
                      setGenMode('analyze');
                      localStorage.setItem('manga_gen_mode', 'analyze');
                    }}
                    class="w-full p-3 rounded-lg border-2 text-left ${genMode === 'analyze' ? 'border-blue-500 bg-blue-50' : 'border-gray-300 hover:bg-gray-50'}"
                  >
                    <div class="font-semibold text-sm">è©³ç´°ãƒ¢ãƒ¼ãƒ‰</div>
                    <div class="text-xs text-gray-600 mt-1">2ã‚¹ãƒ†ãƒƒãƒ—ã§ç²¾å¯†ç”Ÿæˆ</div>
                  </button>
                </div>
              </div>
            </div>

            <div class="mb-4 border-t pt-4">
              <button onClick=${function() { setShowAdvancedSettings(!showAdvancedSettings); }} class="flex items-center justify-between w-full text-left">
                <span class="text-sm font-semibold text-gray-700">è©³ç´°è¨­å®š</span>
                <span class="text-gray-400">${showAdvancedSettings ? 'â–¼' : 'â–¶'}</span>
              </button>
              <div class="accordion-content ${showAdvancedSettings ? 'open' : ''}">
                <div class="py-2 space-y-4">

                  <div>
                    <div class="text-sm font-medium text-gray-700 mb-2">ã‚µãƒ–ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è‡ªå‹•ç”Ÿæˆ</div>
                    <label class="flex items-center cursor-pointer hover:bg-gray-50 p-2 rounded-lg">
                      <input
                        type="checkbox"
                        checked=${enableSubChars}
                        onChange=${function(e) {
                          setEnableSubChars(e.target.checked);
                          localStorage.setItem('manga_enable_sub_chars', e.target.checked);
                        }}
                        class="mr-2"
                      />
                      <div class="flex-1">
                        <div class="text-xs text-gray-600">ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã«ç™»å ´ã™ã‚‹è¿½åŠ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ï¼ˆãŠå®¢æ§˜ã€åº—å“¡ãªã©ï¼‰ã‚’AIãŒè‡ªå‹•ç”Ÿæˆã—ã¦ç™»å ´ã•ã›ã¾ã™</div>
                      </div>
                    </label>
                  </div>

                  <div>
                    <div class="text-sm font-medium text-gray-700 mb-2">ã‚»ãƒªãƒ•ã‚¹ã‚¿ã‚¤ãƒ«</div>
                    <div class="flex gap-2">
                      <label class="flex-1 flex items-center justify-center p-2 rounded-lg cursor-pointer border-2 ${speech === 'formal' ? 'border-blue-500 bg-blue-50' : 'border-gray-200'}">
                        <input type="radio" checked=${speech === 'formal'} onChange=${function() { setSpeech('formal'); }} class="sr-only" />
                        <span class="text-sm">æ•¬èª</span>
                      </label>
                      <label class="flex-1 flex items-center justify-center p-2 rounded-lg cursor-pointer border-2 ${speech === 'casual' ? 'border-blue-500 bg-blue-50' : 'border-gray-200'}">
                        <input type="radio" checked=${speech === 'casual'} onChange=${function() { setSpeech('casual'); }} class="sr-only" />
                        <span class="text-sm">ã‚¿ãƒ¡å£</span>
                      </label>
                    </div>
                  </div>

                  <div>
                    <div class="text-sm font-medium text-gray-700 mb-2">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä¸åœ¨ãƒ‘ãƒãƒ«</div>
                    <div class="flex gap-2">
                      ${[0, 1, 2].map(function(count) {
                        return html`
                          <button
                            key=${count}
                            onClick=${function() {
                              setCharAbsentCount(count);
                              localStorage.setItem('manga_char_absent_count', count);
                            }}
                            class="flex-1 p-2 rounded-lg border-2 text-center ${charAbsentCount === count ? 'border-blue-500 bg-blue-50' : 'border-gray-300 hover:bg-gray-50'}"
                          >
                            <div class="text-sm font-semibold">${count === 0 ? 'ãªã—' : count + 'å›'}</div>
                            <div class="text-xs text-gray-500 mt-1">${count === 0 ? 'å…¨4ã‚³ãƒ' : (4 - count) + 'ã‚³ãƒç™»å ´'}</div>
                          </button>
                        `;
                      })}
                    </div>
                    <div class="text-xs text-gray-500 mt-2">
                      ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä¸åœ¨ãƒ‘ãƒãƒ«ã§ã¯ã€å›³è§£ãƒ»ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ»ã‚¯ãƒ­ãƒ¼ã‚ºã‚¢ãƒƒãƒ—ãªã©ã§å†…å®¹ã‚’è¦–è¦šçš„ã«è¡¨ç¾ã—ã¾ã™ã€‚
                    </div>
                  </div>

                </div>
              </div>
            </div>
          </div>

          <div class="flex-1 p-4 md:p-6 overflow-y-auto">
            <div class="md:hidden flex items-center justify-between mb-4">
              <button onClick=${function() { setSidebar(true); }} class="text-2xl">â˜°</button>
              <h1 class="text-lg font-bold">æ¼«ç”»ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼</h1>
              <div class="w-8"></div>
            </div>

            <div class="mb-6">
              <div class="flex items-center mb-2"><span class="text-lg font-semibold text-gray-700">ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ»è¨˜äº‹å†…å®¹</span><${HelpIcon} text=${HELP.story} /></div>
              <textarea value=${story} onInput=${function(e) { setStory(e.target.value); }} placeholder="æ¼«ç”»ã«ã—ãŸã„å†…å®¹ã‚’å…¥åŠ›..." class="w-full h-40 p-4 border rounded-lg resize-y"></textarea>
              <div class="flex justify-between text-xs text-gray-500 mt-1">
                <span>${lastSave ? 'è‡ªå‹•ä¿å­˜ ' + lastSave.toLocaleTimeString() : ''}</span>
                <span>${story.length}æ–‡å­—</span>
              </div>
              <div class="text-xs text-gray-600 mt-2">
                è©³ç´°ãªã‚³ãƒè¨­å®š: ä½ç½® / ã‚µã‚¤ã‚º / å†…å®¹ / ã‚»ãƒªãƒ• / èƒŒæ™¯ / ã‚­ãƒ£ãƒ© / è¡¨æƒ… / ã‚«ãƒ¡ãƒ©ã‚¢ãƒ³ã‚°ãƒ« / ã‚«ãƒ¡ãƒ©è·é›¢
                <button onClick=${function() { setShowPanelHelp(true); }} class="text-blue-500 hover:text-blue-600 ml-2">
                  [è©³ç´°ã‚’è¦‹ã‚‹]
                </button>
              </div>
            </div>

            <div class="mb-6 p-4 bg-gray-50 rounded-lg flex flex-wrap items-center gap-4">
              <span class="text-sm text-gray-700">ç”Ÿæˆæšæ•°</span>
              <div class="flex gap-2">${[1, 2, 3, 4, 5].map(function(n) { return html`<button key=${n} onClick=${function() { setGenCount(n); }} class="w-10 h-10 rounded-lg border-2 ${genCount === n ? 'border-blue-500 bg-blue-50' : 'border-gray-300'}">${n}</button>`; })}</div>
              <div class="text-sm text-gray-600">äºˆæƒ³: $${est().usd}ï¼ˆç´„${est().jpy}å††ï¼‰</div>
            </div>

            <div class="mb-6">
              ${isGen ? html`
                <div class="p-4 bg-blue-50 rounded-lg">
                  <div class="flex items-center justify-between mb-2">
                    <div>
                      <div class="font-semibold">ç”Ÿæˆä¸­... ${genIdx + 1}/${genCount}æš</div>
                      ${currentStep > 0 && totalSteps > 0 && html`<div class="text-sm text-blue-700 mt-1">Step ${currentStep}/${totalSteps}: ${promptSteps[currentStep - 1] ? promptSteps[currentStep - 1].name : ''}ä¸­...</div>`}
                    </div>
                    <button onClick=${function() { cancelRef.current = true; }} class="px-4 py-2 bg-red-500 text-white text-sm rounded-lg">åœæ­¢</button>
                  </div>
                  <div class="w-full bg-gray-200 rounded-full h-2"><div class="bg-blue-500 h-2 rounded-full transition-all" style=${{ width: ((genIdx + 1) / genCount * 100) + '%' }}></div></div>
                  ${currentStep > 0 && totalSteps > 0 && html`
                    <div class="mt-2 flex items-center gap-2 text-xs text-blue-600 overflow-x-auto">
                      ${promptSteps.map(function(step, idx) {
                        var stepNum = idx + 1;
                        var isActive = stepNum === currentStep;
                        var isDone = stepNum < currentStep;
                        return html`
                          <div key=${idx} class="flex items-center gap-1 flex-shrink-0">
                            <div class="w-2 h-2 rounded-full ${isActive ? 'bg-blue-500 animate-pulse' : isDone ? 'bg-green-500' : 'bg-gray-300'}"></div>
                            <span class="${isActive ? 'font-semibold' : ''}">${step.name}</span>
                          </div>
                          ${idx < promptSteps.length - 1 && html`<span class="flex-shrink-0">â†’</span>`}
                        `;
                      })}
                    </div>
                  `}
                  ${genImages.length > 0 && html`<div class="mt-4 flex gap-2 overflow-x-auto">${genImages.map(function(img, i) { return html`<img key=${i} src=${img} class="w-20 h-28 object-cover rounded-lg cursor-pointer border-2 ${curImg === i ? 'border-blue-500' : 'border-gray-200'}" onClick=${function() { setCurImg(i); }} />`; })}</div>`}
                </div>
              ` : html`<button onClick=${generate} disabled=${!apiSaved} class="w-full py-4 bg-gradient-to-r from-orange-500 to-orange-600 text-white text-lg font-bold rounded-lg disabled:opacity-50">æ¼«ç”»ã‚’ç”Ÿæˆï¼ˆ${genCount}æšï¼‰</button>`}
              ${error && html`<div class="text-red-600 text-sm mt-2 text-center">${error}</div>`}
            </div>

            <div class="mb-6">
              <div class="flex items-center justify-between mb-2">
                <span class="text-lg font-semibold text-gray-700">ç”Ÿæˆã•ã‚ŒãŸæ¼«ç”»</span>
                ${genImages.length > 0 && html`<span class="text-sm text-gray-500">${curImg + 1}/${genImages.length}æš</span>`}
              </div>
              <div class="bg-gray-100 rounded-lg p-4 min-h-64 flex items-center justify-center relative">
                ${genImages.length > 0 ? html`
                  ${curImg > 0 && html`
                    <button
                      onClick=${function() { setCurImg(curImg - 1); }}
                      class="absolute left-2 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-50 hover:bg-opacity-70 text-white rounded-full w-10 h-10 flex items-center justify-center transition-all z-10"
                    >
                      â†
                    </button>
                  `}
                  <img
                    src=${genImages[curImg]}
                    class="max-w-full max-h-[500px] rounded-lg shadow-lg cursor-pointer"
                    onClick=${function() { setModalImg(genImages[curImg]); setModalImgIdx(curImg); setShowImg(true); }}
                  />
                  ${curImg < genImages.length - 1 && html`
                    <button
                      onClick=${function() { setCurImg(curImg + 1); }}
                      class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-50 hover:bg-opacity-70 text-white rounded-full w-10 h-10 flex items-center justify-center transition-all z-10"
                    >
                      â†’
                    </button>
                  `}
                ` : html`<div class="text-gray-400 text-center"><div class="text-4xl mb-2">â—‹</div><div>ã“ã“ã«æ¼«ç”»ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div></div>`}
              </div>
              ${genImages.length > 1 && html`<div class="flex justify-center gap-2 mt-4">${genImages.map(function(_, i) { return html`<button key=${i} onClick=${function() { setCurImg(i); }} class="w-10 h-10 rounded-lg border-2 ${curImg === i ? 'border-blue-500 bg-blue-50' : 'border-gray-300'}">${i + 1}</button>`; })}</div>`}
              ${genImages.length > 0 && html`<div class="flex gap-3 mt-4 justify-center"><button onClick=${function() { dl(genImages[curImg], curImg); }} class="px-4 py-2 bg-blue-500 text-white text-sm rounded-lg">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button><button onClick=${function() { setGenImages([]); }} class="px-4 py-2 bg-gray-500 text-white text-sm rounded-lg">ã‚¯ãƒªã‚¢</button></div>`}
            </div>

            ${history.length > 0 && html`
              <div>
                <div class="flex items-center justify-between mb-2"><span class="text-lg font-semibold text-gray-700">ç”Ÿæˆå±¥æ­´</span><button onClick=${function() { setShowHist(true); }} class="text-sm text-blue-500">ã™ã¹ã¦è¦‹ã‚‹</button></div>
                <div class="flex gap-3 overflow-x-auto pb-2 scrollbar-thin">${history.slice(0, 5).map(function(h) { return html`<div key=${h.id} class="flex-shrink-0 cursor-pointer relative" onClick=${function() { setHistDet(h); setShowHistDet(true); }}>${favHist.indexOf(h.id) >= 0 && html`<div class="absolute top-1 left-1 text-yellow-500">â˜…</div>`}<img src=${h.img} class="w-20 h-28 object-cover rounded-lg border-2 border-gray-200 hover:border-blue-400" /></div>`; })}</div>
              </div>
            `}
          </div>

          <${Modal} isOpen=${showTut} onClose=${function() {}} title="ä½¿ã„æ–¹" size="md">
            <div class="text-center">
              <div class="flex justify-center gap-1 mb-4">${TUTORIAL.map(function(_, i) { return html`<div key=${i} class="w-3 h-3 rounded-full ${i === tutStep ? 'bg-blue-500' : 'bg-gray-300'}"></div>`; })}</div>
              <h4 class="text-xl font-bold mb-4">${TUTORIAL[tutStep].title}</h4>
              <p class="text-gray-700 mb-6 min-h-24 whitespace-pre-wrap">${TUTORIAL[tutStep].content}</p>
              <div class="flex justify-between">
                <button onClick=${function() { setTutStep(Math.max(0, tutStep - 1)); }} class="px-4 py-2 text-gray-600" disabled=${tutStep === 0}>â† æˆ»ã‚‹</button>
                <button onClick=${compTut} class="px-4 py-2 text-gray-500">ã‚¹ã‚­ãƒƒãƒ—</button>
                ${tutStep < TUTORIAL.length - 1 ? html`<button onClick=${function() { setTutStep(tutStep + 1); }} class="px-4 py-2 bg-blue-500 text-white rounded-lg">æ¬¡ã¸ â†’</button>` : html`<button onClick=${compTut} class="px-4 py-2 bg-blue-500 text-white rounded-lg">å§‹ã‚ã‚‹</button>`}
              </div>
            </div>
          <//>

          <${Modal} isOpen=${showSamp} onClose=${function() { setShowSamp(false); }} title="ã‚µãƒ³ãƒ—ãƒ«ã‚®ãƒ£ãƒ©ãƒªãƒ¼" size="lg">
            <p class="text-gray-600 mb-4">ã“ã®ãƒ„ãƒ¼ãƒ«ã§ä½œæˆã§ãã‚‹æ¼«ç”»ã®ä¾‹ã§ã™</p>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">${SAMPLES.map(function(s) { return html`<div key=${s.id} class="border rounded-lg p-3"><div class="bg-gray-200 h-32 rounded mb-2 flex items-center justify-center text-gray-400 text-sm">ã‚µãƒ³ãƒ—ãƒ«ç”»åƒ</div><div class="text-sm font-semibold">${s.title}</div><div class="text-xs text-gray-500">${s.cat}</div></div>`; })}</div>
          <//>

          <${Modal} isOpen=${showHist} onClose=${function() { setShowHist(false); }} title="ç”Ÿæˆå±¥æ­´" size="lg">
            <div class="grid grid-cols-3 md:grid-cols-4 gap-3">${history.map(function(h) { return html`<div key=${h.id} class="cursor-pointer relative" onClick=${function() { setHistDet(h); setShowHistDet(true); setShowHist(false); }}>${favHist.indexOf(h.id) >= 0 && html`<div class="absolute top-1 left-1 text-yellow-500 z-10">â˜…</div>`}<img src=${h.img} class="w-full h-32 object-cover rounded-lg border-2 border-gray-200" /></div>`; })}</div>
          <//>

          <${Modal} isOpen=${showHistDet} onClose=${function() { setShowHistDet(false); }} title="è©³ç´°" size="lg">
            ${histDet && html`<div class="flex flex-col md:flex-row gap-4"><div class="flex-1"><img src=${histDet.img} class="w-full rounded-lg cursor-pointer" onClick=${function() { setModalImg(histDet.img); setShowImg(true); }} /></div><div class="flex-1"><h4 class="font-semibold mb-2">ç”Ÿæˆè¨­å®š</h4><div class="space-y-2 text-sm"><div>ãƒ†ã‚¤ã‚¹ãƒˆ: ${histDet.settings ? histDet.settings.styleName : '-'}</div><div>ã‚»ãƒªãƒ•: ${histDet.settings && histDet.settings.speech === 'formal' ? 'æ•¬èª' : 'ã‚¿ãƒ¡å£'}</div><div>ãƒ¢ãƒ‡ãƒ«: ${histDet.settings ? histDet.settings.modelName : '-'}</div><div>æ—¥æ™‚: ${new Date(histDet.ts).toLocaleString()}</div></div><div class="flex gap-2 mt-4"><button onClick=${function() { toggleFavHist(histDet.id); }} class="px-3 py-2 border rounded-lg ${favHist.indexOf(histDet.id) >= 0 ? 'border-yellow-500 bg-yellow-50' : ''}">${favHist.indexOf(histDet.id) >= 0 ? 'â˜… è§£é™¤' : 'â˜† ç™»éŒ²'}</button><button onClick=${function() { dl(histDet.img, 0); }} class="px-3 py-2 bg-blue-500 text-white rounded-lg">DL</button></div></div></div>`}
          <//>

          <${Modal} isOpen=${showUsage} onClose=${function() { setShowUsage(false); }} title="ä½¿ç”¨é‡" size="md">
            <div class="space-y-4">
              <div><h4 class="font-semibold mb-2">ä»Šæœˆ</h4><div class="bg-gray-50 rounded-lg p-4"><div class="text-2xl font-bold">${mu.count}æš</div><div class="text-gray-600">æ¨å®š: $${mu.cost.toFixed(2)}</div></div></div>
              <div><h4 class="font-semibold mb-2">ç´¯è¨ˆ</h4><div class="bg-gray-50 rounded-lg p-4"><div class="flex justify-between"><span>ç·æšæ•°</span><span class="font-bold">${usage.total ? usage.total.count : 0}æš</span></div><div class="flex justify-between"><span>ç´¯è¨ˆ</span><span class="font-bold">$${usage.total ? usage.total.cost.toFixed(2) : '0.00'}</span></div></div></div>
            </div>
          <//>

          <${Modal} isOpen=${showAddChar} onClose=${function() { setShowAddChar(false); setNewCharName(''); setNewCharImg(null); }} title="ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¿½åŠ " size="sm">
            <input type="text" value=${newCharName} onInput=${function(e) { setNewCharName(e.target.value); }} placeholder="åå‰" class="w-full px-3 py-2 border rounded-lg mb-4" />
            <div class="border-2 border-dashed rounded-lg p-4 mb-4 text-center cursor-pointer" onClick=${function() { fileRef.current && fileRef.current.click(); }}>${newCharImg ? html`<img src=${newCharImg} class="max-h-32 mx-auto rounded" />` : html`<div class="text-gray-400"><div class="text-3xl mb-2">+</div><div>ç”»åƒã‚’é¸æŠ</div></div>`}</div>
            <input ref=${fileRef} type="file" accept="image/*" class="hidden" onChange=${function(e) { var f = e.target.files[0]; if (!f) return; var r = new FileReader(); r.onload = function(ev) { setNewCharImg(ev.target.result); }; r.readAsDataURL(f); }} />
            <div class="flex gap-3"><button onClick=${function() { setShowAddChar(false); setNewCharName(''); setNewCharImg(null); }} class="flex-1 py-2 border rounded-lg">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button onClick=${addChar} disabled=${!newCharName || !newCharImg} class="flex-1 py-2 bg-blue-500 text-white rounded-lg disabled:opacity-50">è¿½åŠ </button></div>
          <//>

          <${Modal} isOpen=${showAddProj} onClose=${function() { setShowAddProj(false); setNewProjName(''); }} title="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¿å­˜" size="sm">
            <p class="text-sm text-gray-600 mb-4">ç¾åœ¨ã®è¨­å®šã‚’ä¿å­˜ã—ã¾ã™</p>
            <input type="text" value=${newProjName} onInput=${function(e) { setNewProjName(e.target.value); }} placeholder="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå" class="w-full px-3 py-2 border rounded-lg mb-4" />
            <div class="flex gap-3"><button onClick=${function() { setShowAddProj(false); setNewProjName(''); }} class="flex-1 py-2 border rounded-lg">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button onClick=${saveProj} disabled=${!newProjName} class="flex-1 py-2 bg-blue-500 text-white rounded-lg disabled:opacity-50">ä¿å­˜</button></div>
          <//>

          ${showImg && html`
            <div class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
              <div class="bg-white rounded-xl w-full max-w-7xl h-[90vh] overflow-hidden flex flex-col">
                <div class="flex justify-between items-center p-4 border-b">
                  <h3 class="text-lg font-bold">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
                  <button onClick=${function() { setShowImg(false); }} class="text-gray-500 hover:text-gray-700 text-2xl leading-none">Ã—</button>
                </div>
                <div class="flex gap-4 flex-1 overflow-hidden">
                  <div class="flex-1 flex items-center justify-center bg-gray-900 p-4">
                    <img
                      src=${genImages[modalImgIdx]}
                      class="max-h-full max-w-full object-contain"
                    />
                  </div>
                  <div class="w-64 p-4 flex flex-col gap-4 overflow-y-auto">
                    <div class="flex flex-col gap-3">
                      ${modalImgIdx > 0 && html`
                        <button
                          onClick=${function() { setModalImgIdx(modalImgIdx - 1); }}
                          class="w-full py-3 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors text-center"
                        >
                          â† å‰ã¸
                        </button>
                      `}
                      <div class="text-center text-gray-600 py-2">
                        ${modalImgIdx + 1} / ${genImages.length}
                      </div>
                      ${modalImgIdx < genImages.length - 1 && html`
                        <button
                          onClick=${function() { setModalImgIdx(modalImgIdx + 1); }}
                          class="w-full py-3 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors text-center"
                        >
                          æ¬¡ã¸ â†’
                        </button>
                      `}
                    </div>
                    <a
                      href=${genImages[modalImgIdx]}
                      download=${'manga_' + (modalImgIdx + 1) + '_' + Date.now() + '.png'}
                      class="w-full py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors text-center block"
                    >
                      ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    </a>
                    ${genImages.length > 1 && html`
                      <div class="border-t pt-4">
                        <div class="text-sm font-medium text-gray-700 mb-2">ä»–ã®ç”»åƒ</div>
                        <div class="space-y-2">
                          ${genImages.map(function(img, i) {
                            return html`
                              <img
                                key=${i}
                                src=${img}
                                onClick=${function() { setModalImgIdx(i); }}
                                class="w-full h-32 object-cover rounded cursor-pointer border-2 ${modalImgIdx === i ? 'border-blue-500' : 'border-gray-300'} hover:border-blue-400 transition-all"
                              />
                            `;
                          })}
                        </div>
                      </div>
                    `}
                  </div>
                </div>
              </div>
            </div>
          `}

          <${Modal} isOpen=${showDraft} onClose=${function() { setShowDraft(false); }} title="ä¸‹æ›¸ããŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ" size="sm">
            <p class="text-gray-600 mb-4">å‰å›ã®ä½œæ¥­å†…å®¹ã‚’å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ</p>
            ${draft && html`<div class="bg-gray-50 rounded-lg p-3 mb-4 text-sm"><div class="text-gray-500">ä¿å­˜: ${new Date(draft.ts).toLocaleString()}</div><div class="text-gray-700 mt-1 truncate">ã€Œ${draft.story ? draft.story.substring(0, 50) : ''}...ã€</div></div>`}
            <div class="flex gap-3"><button onClick=${function() { setShowDraft(false); localStorage.removeItem('manga_draft'); }} class="flex-1 py-2 border rounded-lg">ç ´æ£„</button><button onClick=${restoreDraft} class="flex-1 py-2 bg-blue-500 text-white rounded-lg">å¾©å…ƒ</button></div>
          <//>

          <${Modal} isOpen=${showCharDetail} onClose=${function() { setShowCharDetail(false); }} title="ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è©³ç´°è¨­å®š" size="md">
            <div class="flex flex-col items-center">
              ${selChars[charDetailIdx] && html`
                <img src=${selChars[charDetailIdx].img} class="w-48 h-48 object-cover rounded-lg mb-4 border-2 border-blue-400" />
                <div class="w-full space-y-3">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åï¼ˆä»»æ„ï¼‰</label>
                    <input
                      type="text"
                      placeholder="ä¾‹: ç¾å’²"
                      maxLength="10"
                      value=${charDetails[charDetailIdx].name}
                      onInput=${function(e) { updateCharDetail(charDetailIdx, 'name', e.target.value); }}
                      class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    />
                    <p class="text-xs text-gray-500 mt-1">æœ€å¤§10æ–‡å­—</p>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç‰¹å¾´ï¼ˆä»»æ„ï¼‰</label>
                    <textarea
                      placeholder="ä¾‹: é»’é«ªãƒ­ãƒ³ã‚°ãƒ˜ã‚¢ã€é’ã„ç³${'\n'}ç™½ã„ã‚·ãƒ£ãƒ„ã«é»’ã„ã‚¹ã‚«ãƒ¼ãƒˆ${'\n'}å„ªã—ãã¦è½ã¡ç€ã„ãŸé›°å›²æ°—"
                      maxLength="200"
                      value=${charDetails[charDetailIdx].features}
                      onInput=${function(e) { updateCharDetail(charDetailIdx, 'features', e.target.value); }}
                      class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none"
                      rows="5"
                    ></textarea>
                    <p class="text-xs text-gray-500 mt-1">æœ€å¤§200æ–‡å­— | ${charDetails[charDetailIdx].features.length}/200</p>
                  </div>
                  <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <p class="text-xs text-gray-600">â€»ã“ã‚Œã‚‰ã®æƒ…å ±ã¯ä»»æ„å…¥åŠ›ã§ã™ã€‚ç”»åƒç”Ÿæˆæ™‚ã«AIã¸ã®ãƒ’ãƒ³ãƒˆã¨ã—ã¦ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚</p>
                  </div>
                </div>
              `}
            </div>
          <//>

          <${Modal} isOpen=${showPanelHelp} onClose=${function() { setShowPanelHelp(false); }} title="ã‚³ãƒåˆ¥ã®è©³ç´°æŒ‡å®šã‚¬ã‚¤ãƒ‰" size="lg">
            <div class="space-y-4">
              <div class="mb-4">
                <h4 class="font-semibold text-gray-800 mb-2">ã“ã®æ©Ÿèƒ½ã«ã¤ã„ã¦</h4>
                <p class="text-sm text-gray-700">
                  ã‚¹ãƒˆãƒ¼ãƒªãƒ¼å…¥åŠ›æ¬„ã§ <strong>ã€ã‚³ãƒNã€‘</strong> ã®å½¢å¼ã‚’ä½¿ã†ã¨ã€å„ã‚³ãƒã®è©³ç´°ã‚’å€‹åˆ¥ã«æŒ‡å®šã§ãã¾ã™ã€‚<br />
                  2ã€œ4ã‚³ãƒã®æ¼«ç”»ã‚’ä½œã‚‹å ´åˆã‚„ã€ç‰¹å®šã®ã‚³ãƒã ã‘è©³ã—ãæŒ‡å®šã—ãŸã„å ´åˆã«ä¾¿åˆ©ã§ã™ã€‚
                </p>
              </div>

              <div class="space-y-4">
                <h4 class="font-semibold text-gray-800">ä½¿ç”¨ä¾‹</h4>

                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                  <p class="text-sm font-medium text-gray-800 mb-2">è¤‡æ•°ã®é …ç›®ã‚’çµ„ã¿åˆã‚ã›ãŸä¾‹</p>
                  <div class="text-xs text-gray-700 bg-gray-50 p-3 rounded whitespace-pre-wrap">ã€ã‚³ãƒ1ã€‘
ä½ç½®: ä¸Š
ã‚µã‚¤ã‚º: å¤§
èƒŒæ™¯: æ˜ã‚‹ã„ã‚«ãƒ•ã‚§
ã‚»ãƒªãƒ•: ã„ã„å¤©æ°—ã ã­ï¼
è¡¨æƒ…: ç¬‘é¡”

ã€ã‚³ãƒ2ã€‘
ä½ç½®: ä¸‹
ã‚µã‚¤ã‚º: å°
å†…å®¹: è–„æš—ã„éƒ¨å±‹ã€çª“ã‹ã‚‰é›¨ãŒè¦‹ãˆã‚‹
ã‚»ãƒªãƒ•: ...æ€¥ã«é›¨ãŒ
è¡¨æƒ…: å›°æƒ‘</div>
                </div>

                <div class="border-t pt-4">
                  <div class="space-y-3 text-sm">
                    <div>
                      <div class="font-medium text-gray-800">ä½ç½®</div>
                      <div class="text-gray-600 ml-2">ä¾‹: å·¦ä¸Šã€å³ä¸Šã€ä¸­å¤®ã€ä¸Šã€ä¸‹</div>
                    </div>

                    <div>
                      <div class="font-medium text-gray-800">ã‚µã‚¤ã‚º</div>
                      <div class="text-gray-600 ml-2">ä¾‹: å¤§ã€å°ã€ä¸­</div>
                    </div>

                    <div>
                      <div class="font-medium text-gray-800">å†…å®¹</div>
                      <div class="text-gray-600 ml-2">ä¾‹: ä¸»äººå…¬ãŒé©šã„ãŸè¡¨æƒ…ã§æœ¬ã‚’è½ã¨ã™ã€è–„æš—ã„éƒ¨å±‹ã§ãƒ‡ã‚¹ã‚¯ãƒ©ã‚¤ãƒˆã ã‘ãŒæ˜ã‚‹ã„</div>
                      <div class="text-xs text-gray-500 ml-2 mt-1">â€»ç…§æ˜ãƒ»ãƒˆãƒ¼ãƒ³ã‚‚ã“ã“ã§æŒ‡å®šå¯èƒ½ï¼ˆä¾‹: è–„æš—ã„ã€æ˜ã‚‹ã„æ—¥å·®ã—ã€å¤œã®é›°å›²æ°—ï¼‰</div>
                    </div>

                    <div>
                      <div class="font-medium text-gray-800">ã‚»ãƒªãƒ•</div>
                      <div class="text-gray-600 ml-2">ä¾‹: ãˆã£ã€ã“ã‚Œæœ¬å½“ï¼Ÿã€ã‚‚ã†å°‘ã—ã§å®Œæˆã ...</div>
                    </div>

                    <div>
                      <div class="font-medium text-gray-800">èƒŒæ™¯</div>
                      <div class="text-gray-600 ml-2">ä¾‹: æ˜ã‚‹ã„ãƒªãƒ“ãƒ³ã‚°ã€å¤œã®ã‚ªãƒ•ã‚£ã‚¹ã€ã‚«ãƒ•ã‚§ã®åº—å†…</div>
                    </div>

                    <div>
                      <div class="font-medium text-gray-800">ã‚­ãƒ£ãƒ©</div>
                      <div class="text-gray-600 ml-2">ä¾‹: èª¬æ˜è€…ã®ã¿ã€èª¬æ˜è€…ã¨ç›¸è«‡è€…ã€ç›¸è«‡è€…ã®ã¿</div>
                    </div>

                    <div>
                      <div class="font-medium text-gray-800">è¡¨æƒ…</div>
                      <div class="text-gray-600 ml-2">ä¾‹: é©šãã€çœŸå‰£ã€ç¬‘é¡”ã€å›°æƒ‘ã€ç´å¾—</div>
                    </div>

                    <div>
                      <div class="font-medium text-gray-800">ã‚«ãƒ¡ãƒ©ã‚¢ãƒ³ã‚°ãƒ«</div>
                      <div class="text-gray-600 ml-2">ä¾‹: æ­£é¢ã€æ–œã‚ä¸Šã‹ã‚‰ã€æ¨ªé¡”ã€ä¿¯ç°</div>
                    </div>

                    <div>
                      <div class="font-medium text-gray-800">ã‚«ãƒ¡ãƒ©è·é›¢</div>
                      <div class="text-gray-600 ml-2">ä¾‹: ã‚¯ãƒ­ãƒ¼ã‚ºã‚¢ãƒƒãƒ—ã€å…¨èº«ã€ãƒã‚¹ãƒˆã‚·ãƒ§ãƒƒãƒˆ</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          <//>
        </div>
      `;
    }

    ReactDOM.createRoot(document.getElementById('app')).render(React.createElement(App));
  </script>
</body>
</html>
